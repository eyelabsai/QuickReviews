<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Profile Setup</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background:#eef2f7; display:flex; align-items:center; justify-content:center; min-height:100vh; }
    .card { background:#fff; padding:2rem; border-radius:12px; box-shadow:0 6px 20px rgba(0,0,0,0.1); width:90%; max-width:560px; }
    .card h2 { margin-bottom:1rem; text-align:center; }
    label { display:block; margin:.5rem 0 .25rem; }
    input { width:100%; padding:.65rem; border:1px solid #ccc; border-radius:8px; }
    button { margin-top:1rem; width:100%; padding:.75rem; background:#007bff; color:#fff; border:none; border-radius:8px; font-weight:600; cursor:pointer; }
    .error { color:#c00; margin-top:.5rem; text-align:center; display:none; }
    .info { color:#090; margin-top:.5rem; text-align:center; display:none; }
  </style>
  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-analytics-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-storage-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD20NR1jIBq_L3znffAe8c82VH49NcMmeE",
      authDomain: "ezreview-ee8f0.firebaseapp.com",
      projectId: "ezreview-ee8f0",
      storageBucket: "ezreview-ee8f0.firebasestorage.app",
      messagingSenderId: "985522835249",
      appId: "1:985522835249:web:fda8bab4bac91fb898ea10",
      measurementId: "G-RBB28JDVJW"
    };
    firebase.initializeApp(firebaseConfig);
    firebase.analytics();
    const db = firebase.firestore();
    const storage = firebase.storage();
  </script>
</head>
<body>
  <div class="topbar" style="justify-content: space-between; width: 100%;">
    <div></div>
    <div>
      <button id="backBtn" class="btn btn-secondary">Back to dashboard</button>
    </div>
  </div>
  <div class="card">
    <h2>Complete Your Profile</h2>
    <div id="signedInAs" style="text-align:center; margin-bottom: .75rem;"></div>
    <label for="fullName">Full Name</label>
    <input type="text" id="fullName" placeholder="e.g., Sarah Jones" required>
    <label for="reviewLink">Public Review Link</label>
    <input type="url" id="reviewLink" placeholder="https://..." required>

    <label for="practiceName">Practice Name</label>
    <input type="text" id="practiceName" placeholder="Your Clinic Name">

    <label for="logoFile">Practice Logo (PNG/JPG, max 2 MB)</label>
    <input type="file" id="logoFile" accept="image/png,image/jpeg">
    <div id="logoPreview" style="margin-top:.5rem; text-align:center;"></div>
    <button id="saveBtn">Save Profile</button>
    <div id="error" class="error"></div>
    <div id="info" class="info"></div>
  </div>

  <script>
    let userDocRef = null;
    firebase.auth().onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = 'index.html';
        return;
      }
      document.getElementById('signedInAs').textContent = `Signed in as ${user.email}`;

      const qs = await db.collection('users').where('email', '==', user.email).limit(1).get();
      if (qs.empty) {
        // Create a placeholder doc if somehow missing
        userDocRef = db.collection('users').doc(user.uid);
        await userDocRef.set({ email: user.email }, { merge: true });
      } else {
        userDocRef = qs.docs[0].ref;
        const data = qs.docs[0].data();
        if (data.fullName) document.getElementById('fullName').value = data.fullName;
        if (data.reviewLink) document.getElementById('reviewLink').value = data.reviewLink;
        if (data.practiceName) document.getElementById('practiceName').value = data.practiceName;
        if (data.logoUrl) document.getElementById('logoPreview').innerHTML = `<img src="${data.logoUrl}" alt="logo" style="max-height:80px">`;
      }
    });

    document.getElementById('saveBtn').addEventListener('click', async () => {
      const err = document.getElementById('error');
      const info = document.getElementById('info');
      err.style.display = 'none';
      info.style.display = 'none';

      const fullName = document.getElementById('fullName').value.trim();
      const reviewLink = document.getElementById('reviewLink').value.trim();
      const practiceName = document.getElementById('practiceName').value.trim();
      const logoFile = document.getElementById('logoFile').files[0];

      if (!fullName || !reviewLink) {
        err.textContent = 'Both fields are required.';
        err.style.display = 'block';
        return;
      }
      try {
        let logoUrl = null;
        if (logoFile) {
          if (logoFile.size > 2 * 1024 * 1024) {
            err.textContent = 'Logo must be under 2 MB.';
            err.style.display = 'block';
            return;
          }
          const user = firebase.auth().currentUser;
          const ref = storage.ref().child(`logos/${user.uid}/${logoFile.name}`);
          await ref.put(logoFile, { contentType: logoFile.type, cacheControl: 'public,max-age=31536000' });
          logoUrl = await ref.getDownloadURL();
          document.getElementById('logoPreview').innerHTML = `<img src="${logoUrl}" alt="logo" style="max-height:80px">`;
        }

        const updates = { fullName, reviewLink };
        if (practiceName) updates.practiceName = practiceName;
        if (logoUrl) updates.logoUrl = logoUrl;

        await userDocRef.update(updates);
        info.textContent = 'Profile saved. Redirecting to dashboard...';
        info.style.display = 'block';
        setTimeout(() => { window.location.href = 'dashboard.html'; }, 800);
      } catch (e) {
        err.textContent = e.message;
        err.style.display = 'block';
      }
    });

    document.getElementById('backBtn').addEventListener('click', () => {
      window.location.href = 'dashboard.html';
    });
  </script>
</body>
</html>


