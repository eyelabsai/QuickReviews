<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Set New Password</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background: #eef2f7; display:flex; align-items:center; justify-content:center; min-height:100vh; }
    .card { background:#fff; padding:2rem; border-radius:12px; box-shadow:0 6px 20px rgba(0,0,0,0.1); width: 90%; max-width: 420px; }
    .card h2 { margin-bottom:1rem; text-align:center; }
    label { display:block; margin:.5rem 0 .25rem; }
    input { width:100%; padding:.65rem; border:1px solid #ccc; border-radius:8px; }
    button { margin-top:1rem; width:100%; padding:.75rem; background:#007bff; color:#fff; border:none; border-radius:8px; font-weight:600; cursor:pointer; }
    .error { color:#c00; margin-top:.5rem; text-align:center; display:none; }
    .info { color:#090; margin-top:.5rem; text-align:center; display:none; }
  </style>
  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-analytics-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD20NR1jIBq_L3znffAe8c82VH49NcMmeE",
      authDomain: "ezreview-ee8f0.firebaseapp.com",
      projectId: "ezreview-ee8f0",
      storageBucket: "ezreview-ee8f0.firebasestorage.app",
      messagingSenderId: "985522835249",
      appId: "1:985522835249:web:fda8bab4bac91fb898ea10",
      measurementId: "G-RBB28JDVJW"
    };
    firebase.initializeApp(firebaseConfig);
    firebase.analytics();
    const db = firebase.firestore();
  </script>
</head>
<body>
  <div class="card">
    <h2>Set a New Password</h2>
    <div id="signedInAs" style="text-align:center; margin-bottom: .75rem;"></div>
    <label for="newPassword">New Password</label>
    <input type="password" id="newPassword" autocomplete="new-password" required>
    <label for="confirmPassword">Confirm Password</label>
    <input type="password" id="confirmPassword" autocomplete="new-password" required>
    <button id="submitBtn">Update Password</button>
    <div id="error" class="error"></div>
    <div id="info" class="info"></div>
  </div>

  <script>
    firebase.auth().onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = "index.html";
        return;
      }
      document.getElementById('signedInAs').textContent = `Signed in as ${user.email}`;
    });

    document.getElementById('submitBtn').addEventListener('click', async () => {
      const err = document.getElementById('error');
      const info = document.getElementById('info');
      err.style.display = 'none';
      info.style.display = 'none';
      const newPass = document.getElementById('newPassword').value.trim();
      const confirm = document.getElementById('confirmPassword').value.trim();

      if (!newPass || newPass.length < 8) {
        err.textContent = 'Password must be at least 8 characters.';
        err.style.display = 'block';
        return;
      }
      if (newPass !== confirm) {
        err.textContent = 'Passwords do not match.';
        err.style.display = 'block';
        return;
      }

      try {
        const user = firebase.auth().currentUser;
        await user.updatePassword(newPass);
        // Clear needsPasswordChange flag
        const qs = await db.collection('users').where('email', '==', user.email).limit(1).get();
        if (!qs.empty) {
          await qs.docs[0].ref.update({ needsPasswordChange: false });
        }
        info.textContent = 'Password updated successfully. Redirecting to profile setup...';
        info.style.display = 'block';
        setTimeout(() => { window.location.href = 'profile.html'; }, 800);
      } catch (e) {
        err.textContent = e.message;
        err.style.display = 'block';
      }
    });
  </script>
</body>
</html>


