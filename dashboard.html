<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Patient Info Entry</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }
  body {
    font-family: 'Inter', sans-serif;
    background: #eef2f7;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .logo-container {
    padding: 1rem;
    text-align: center;
  }
  .logo-container img {
    height: 60px;
    max-width: 100%;
  }
  .header {
    width: 100%;
    background-color: #007bff;
    color: white;
    padding: 0.75rem 1.5rem;
    text-align: center;
    font-size: 1.2rem;
    font-weight: 500;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
  }
  .card {
    background: #ffffff;
    padding: 2rem;
    border-radius: 12px;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
    max-width: 600px;
    width: 90%;
    margin-top: 2rem;
  }
  .card h2 {
    font-size: 1.6rem;
    margin-bottom: 1.5rem;
    color: #333;
    text-align: center;
  }
  form {
    display: grid;
    gap: 1.25rem;
  }
  .form-group {
    display: flex;
    flex-direction: column;
  }
  .checkbox-group {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  label {
    font-size: 0.95rem;
    margin-bottom: 0.4rem;
    color: #555;
    font-weight: 500;
  }
  input, textarea {
    padding: 0.65rem;
    border: 1px solid #ccc;
    border-radius: 8px;
    font-size: 1rem;
    transition: border-color 0.2s;
  }
  input:focus, textarea:focus {
    border-color: #007bff;
    outline: none;
  }
  button {
    background-color: #007bff;
    color: #fff;
    border: none;
    border-radius: 8px;
    padding: 0.75rem;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.3s;
  }
  button:hover {
    background-color: #0056b3;
  }
  @media (min-width: 600px) {
    form {
      grid-template-columns: 1fr 1fr;
      gap: 1rem 1.5rem;
    }
    .form-group.full {
      grid-column: 1 / -1;
    }
  }
    .preview-box {
  white-space: pre-wrap;
  background-color: #f9f9f9;
  border: 1px solid #ccc;
  border-radius: 8px;
  padding: 0.75rem;
  font-size: 1rem;
  color: #333;
  min-height: 120px;
}
.preview-box a {
  color: #007bff;
  text-decoration: underline;
}
</style>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-analytics-compat.js"></script>
</head>
<body>
  <div class="logo-container">
    <img src="https://dummyimage.com/200x60/007bff/ffffff&text=Your+Logo" alt="Logo">
  </div>
  <div class="header" id="headerText">
    Review for: [Loading...]
  </div>
  
  <div class="card">
    <h2>Enter Patient Info</h2>
    <form id="patientForm">
      <div class="form-group">
        <label for="fullName">Patient Full Name</label>
        <input type="text" id="fullName" name="fullName" required>
      </div>

      <div class="form-group">
        <label for="preferredName">Preferred Name</label>
        <input type="text" id="preferredName" name="preferredName" required>
      </div>

      <div class="form-group">
        <label for="phone">Phone Number</label>
        <input type="tel" id="phone" name="phone" placeholder="5551234567">
      </div>

      <div class="form-group">
        <label for="email">Email Address</label>
        <input type="email" id="email" name="email">
      </div>

      <div class="form-group full">
        <label for="message">Custom Message</label>
        <textarea id="message" name="message" rows="6" placeholder="Your message will go here..."></textarea>
      </div>

      <div class="form-group full">
  <label>Message Preview</label>
  <div id="messagePreview" class="preview-box"></div>
</div>

      <div class="form-group checkbox-group full">
        <input type="checkbox" id="sendText" name="sendText">
        <label for="sendText">Send Text Message</label>
      </div>

      <div class="form-group checkbox-group full">
        <input type="checkbox" id="sendEmail" name="sendEmail">
        <label for="sendEmail">Send Email</label>
      </div>

      <div class="form-group full">
        <button type="submit">Send Message</button>
      </div>
    </form>
  </div>

  <!-- Main Script -->
  <script>
   document.addEventListener("DOMContentLoaded", function () {
  const firebaseConfig = {
    apiKey: "AIzaSyD20NR1jIBq_L3znffAe8c82VH49NcMmeE",
    authDomain: "ezreview-ee8f0.firebaseapp.com",
    projectId: "ezreview-ee8f0",
    storageBucket: "ezreview-ee8f0.firebasestorage.app",
    messagingSenderId: "985522835249",
    appId: "1:985522835249:web:fda8bab4bac91fb898ea10",
    measurementId: "G-RBB28JDVJW"
  };

  firebase.initializeApp(firebaseConfig);
  firebase.analytics();
  const db = firebase.firestore();

  let reviewLink = "";

  // üîí Get username first
  const username = localStorage.getItem("username");

  if (!username) {
    window.location.href = "index.html";
    return;
  }
 // Preferred name behavior
 const preferredNameInput = document.getElementById("preferredName");
const messageBox = document.getElementById("message");

const messagePreview = document.getElementById("messagePreview");

// üì§ Live preview with link formatting


// üîÅ Update preview whenever message box changes
messageBox.addEventListener("input", updateMessagePreview);

function updateMessagePreview() {
  let previewText = messageBox.value;

  // Replace any URL with a clickable link
  const urlRegex = /(https?:\/\/[^\s]+)/g;
  previewText = previewText.replace(urlRegex, function(url) {
    return `<a href="${url}" target="_blank">Click here to leave a review</a>`;
  });

  messagePreview.innerHTML = previewText.replace(/\n/g, "<br>");
}

     

// üîÅ Extract message generation into reusable function
function updateMessageWithPreferredName() {
  const name = preferredNameInput.value || "[preferred name]";
  let defaultMessage = `Hello ${name},

Thank you so much for letting us take care of you. We hope you enjoyed your time with us. Feedback is very valuable and we would love to hear from you.`;

  if (reviewLink) {
    defaultMessage += `\n\nPlease leave us a review at the following link:\n${reviewLink}`;
  }

  defaultMessage += `

Thanks!
Sarah`;

  const isAutoGenerated = (
    messageBox.value === "" ||
    messageBox.value.startsWith("Hello ") && messageBox.value.includes("Feedback is very valuable")
  );

  if (isAutoGenerated) {
    messageBox.value = defaultMessage;
  } else {
    messageBox.value = messageBox.value.replace(/^Hello .*,/m, `Hello ${name},`);
  }

    updateMessagePreview();  // ‚úÖ Fix: refresh preview after programmatic message update

}

preferredNameInput.addEventListener("input", updateMessageWithPreferredName);



  // üîó Load review link early
db.collection("users").doc(username).get()
  .then(doc => {
    if (doc.exists && doc.data().reviewLink) {
      reviewLink = doc.data().reviewLink;
      console.log("‚úÖ Review link loaded early:", reviewLink);

      // ‚úÖ Force message update regardless of preferred name field
      updateMessageWithPreferredName();
      updateMessagePreview();  // üü¢ force preview to re-render after link is injected

    } else {
      console.warn("‚ö†Ô∏è No review link found for user.");
    }
  })
    .catch(err => {
      console.error("‚ùå Error loading review link:", err);
    });

  // üßæ Update header
  document.getElementById("headerText").textContent = `Review for: ${username}`;

  // üîí Enforce login
  firebase.auth().onAuthStateChanged((user) => {
    if (!user) {
      console.warn("üîí Not authenticated. Redirecting to login.");
      window.location.href = "index.html";
    } else {
      console.log("‚úÖ Authenticated as:", user.email);
    }
  });
     
      document.getElementById("patientForm").addEventListener("submit", async function (e) {
        e.preventDefault();

        const phone = document.getElementById("phone").value.trim();
        const email = document.getElementById("email").value.trim();
        const preferredName = document.getElementById("preferredName").value.trim();
        const sendText = document.getElementById("sendText").checked;
        const sendEmail = document.getElementById("sendEmail").checked;
        let message = document.getElementById("message").value.trim();

        if (!(sendText || sendEmail)) {
          alert("Please select at least one delivery method (Text or Email).");
          return;
        }

        // üîó Append review link if available
        const linkLine = reviewLink ? `\n\nReview link: ${reviewLink}` : "";

        try {
          if (sendText && phone && message) {
            const smsPayload = {
              to: "+1" + phone.replace(/\D/g, ""),
              body: message + linkLine
            };
            console.log("üì± Sending SMS:", smsPayload);
            await db.collection("messages").add(smsPayload);
            alert("SMS message queued for delivery.");
          }

          if (sendEmail && email && message) {
  const mailPayload = {
    to: email,
    message: {
      subject: `We‚Äôd love your feedback, ${preferredName || "friend"}!`,
html: message.replace(/(https?:\/\/[^\s]+)/g, function(url) {
  return `<a href="${url}" target="_blank">Click here to leave a review</a>`;
})    }
  };

          
            console.log("üìß Sending email:", mailPayload);
            await db.collection("mail").add(mailPayload);
            alert("Email queued for delivery.");
          }
        } catch (err) {
          console.error("‚ùå Error during submission:", err);
          alert("‚ùå Failed to send one or more messages:\n" + err.message);
        }
      });
    });
  </script>
</body>
</html>
