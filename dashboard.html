<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Patient Info Entry</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    /* ... your CSS (unchanged) ... */
  </style>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-analytics-compat.js"></script>
</head>
<body>
  <div class="logo-container">
    <img src="https://via.placeholder.com/200x60?text=Your+Logo" alt="Logo">
  </div>
  <div class="header" id="headerText">
    Review for: [Loading...]
  </div>

  <div class="card">
    <h2>Enter Patient Info</h2>
    <form id="patientForm">
      <!-- ... your form (unchanged) ... -->
    </form>
  </div>

  <!-- Main Script -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const firebaseConfig = {
      apiKey: "AIzaSyD20NR1jIBq_L3znffAe8c82VH49NcMmeE",
      authDomain: "ezreview-ee8f0.firebaseapp.com",
      projectId: "ezreview-ee8f0",
      storageBucket: "ezreview-ee8f0.firebasestorage.app",
      messagingSenderId: "985522835249",
      appId: "1:985522835249:web:fda8bab4bac91fb898ea10",
      measurementId: "G-RBB28JDVJW"
    };

    firebase.initializeApp(firebaseConfig);
    firebase.analytics();
    const db = firebase.firestore();

    let reviewLink = ""; // üß© Stored from Firestore

    // üîí Require Firebase Auth login
    firebase.auth().onAuthStateChanged((user) => {
      if (!user) {
        console.warn("üîí Not authenticated. Redirecting to login.");
        window.location.href = "index.html";
      } else {
        console.log("‚úÖ Authenticated as:", user.email);
      }
    });

    // üîí LocalStorage-based username (visual only)
    const username = localStorage.getItem("username");
    if (!username) {
      window.location.href = "index.html";
      return;
    } else {
      document.getElementById("headerText").textContent = `Review for: ${username}`;

      // üì• Fetch reviewLink from Firestore
      db.collection("users").doc(username).get().then(doc => {
        if (doc.exists && doc.data().reviewLink) {
          reviewLink = doc.data().reviewLink;
        }
      }).catch(err => {
        console.error("‚ö†Ô∏è Failed to fetch reviewLink:", err);
      });
    }

    const preferredNameInput = document.getElementById("preferredName");
    const messageBox = document.getElementById("message");

    preferredNameInput.addEventListener("input", () => {
      const name = preferredNameInput.value || "[preferred name]";
      const defaultMessage = `Hello ${name},

Thank you so much for letting us take care of you. We hope you enjoyed your time with us. Feedback is very valuable and we would love to hear from you. Please visit this link to leave a review!

Thanks!
Sarah`;

      if (messageBox.value === "" || messageBox.value.includes("[preferred name]")) {
        messageBox.value = defaultMessage;
      } else {
        messageBox.value = messageBox.value.replace(/^Hello .*,/m, `Hello ${name},`);
      }
    });

    document.getElementById("patientForm").addEventListener("submit", async function (e) {
      e.preventDefault();

      const phone = document.getElementById("phone").value.trim();
      const email = document.getElementById("email").value.trim();
      const preferredName = document.getElementById("preferredName").value.trim();
      const sendText = document.getElementById("sendText").checked;
      const sendEmail = document.getElementById("sendEmail").checked;
      let message = document.getElementById("message").value.trim();

      if (!(sendText || sendEmail)) {
        alert("Please select at least one delivery method (Text or Email).");
        return;
      }

      // üîó Append review link if available
      const linkLine = reviewLink ? `\n\nReview link: ${reviewLink}` : "";

      try {
        if (sendText && phone && message) {
          const smsPayload = {
            to: "+1" + phone.replace(/\D/g, ""),
            body: message + linkLine
          };
          console.log("üì± Sending SMS:", smsPayload);
          await db.collection("messages").add(smsPayload);
          alert("SMS message queued for delivery.");
        }

        if (sendEmail && email && message) {
          const mailPayload = {
            to: email,
            message: {
              subject: `We‚Äôd love your feedback, ${preferredName || "friend"}!`,
              text: message + (reviewLink ? `\n\nReview link: <${reviewLink}>` : "")
            }
          };
          console.log("üìß Sending email:", mailPayload);
          await db.collection("mail").add(mailPayload);
          alert("Email queued for delivery.");
        }
      } catch (err) {
        console.error("‚ùå Error during submission:", err);
        alert("‚ùå Failed to send one or more messages:\n" + err.message);
      }
    });
  });
</script>

  
</body>
</html>
