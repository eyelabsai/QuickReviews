<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>QuickReviews Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }
  
  :root {
    --primary-blue: #1e3a8a;
    --primary-blue-hover: #1e40af;
    --secondary-blue: #3b82f6;
    --light-blue: #dbeafe;
    --dark-blue: #1e293b;
    --text-primary: #1f2937;
    --text-secondary: #6b7280;
    --background: #f8fafc;
    --card-bg: #ffffff;
    --border: #e5e7eb;
    --success: #10b981;
    --warning: #f59e0b;
    --error: #ef4444;
  }
  
  body {
    font-family: 'Inter', sans-serif;
    background: var(--background);
    min-height: 100vh;
    color: var(--text-primary);
  }
  
  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 1rem;
  }
  
  /* Header */
  .header {
    background: var(--card-bg);
    border-bottom: 1px solid var(--border);
    padding: 1rem 0;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }
  
  .header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .logo-section {
    display: flex;
    align-items: center;
    gap: 1rem;
  }
  
  .logo-section img {
    height: 40px;
    border-radius: 8px;
  }
  
  .practice-name {
    font-weight: 600;
    color: var(--text-primary);
  }
  
  .header-actions {
    display: flex;
    gap: 0.75rem;
  }
  
  /* Navigation Tabs */
  .nav-tabs {
    background: var(--card-bg);
    border-bottom: 1px solid var(--border);
    margin-bottom: 2rem;
  }
  
  .nav-tabs .container {
    display: flex;
    gap: 0;
  }
  
  .nav-tab {
    padding: 1rem 1.5rem;
    background: transparent;
    border: none;
    border-bottom: 3px solid transparent;
    color: var(--text-secondary);
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
  }
  
  .nav-tab.active {
    color: var(--primary-blue);
    border-bottom-color: var(--primary-blue);
    background: var(--light-blue);
  }
  
  .nav-tab:hover:not(.active) {
    color: var(--text-primary);
    background: #f9fafb;
  }
  
  /* Tab Content */
  .tab-content {
    display: none;
  }
  
  .tab-content.active {
    display: block;
  }
  
  /* Cards */
  .card {
    background: var(--card-bg);
    border-radius: 12px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    border: 1px solid var(--border);
    overflow: hidden;
  }
  
  .card-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--border);
    background: #fafafa;
  }
  
  .card-header h2 {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-primary);
    margin: 0;
  }
  
  .card-body {
    padding: 1.5rem;
  }
  
  /* Form Styles */
  .form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
  }
  
  .form-group {
    display: flex;
    flex-direction: column;
  }
  
  .form-group.full {
    grid-column: 1 / -1;
  }
  
  label {
    font-weight: 500;
    margin-bottom: 0.5rem;
    color: var(--text-primary);
    font-size: 0.875rem;
  }
  
  input, textarea {
    padding: 0.75rem;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 1rem;
    transition: all 0.2s ease;
    background: #fff;
  }
  
  input:focus, textarea:focus {
    outline: none;
    border-color: var(--secondary-blue);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }
  
  textarea {
    resize: vertical;
    min-height: 180px;
  }
  
  /* Buttons */
  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.875rem;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
  }
  
  .btn-primary {
    background: var(--primary-blue);
    color: white;
  }
  
  .btn-primary:hover {
    background: var(--primary-blue-hover);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(30, 58, 138, 0.3);
  }
  
  .btn-secondary {
    background: #f3f4f6;
    color: var(--text-primary);
    border: 1px solid var(--border);
  }
  
  .btn-secondary:hover {
    background: #e5e7eb;
  }
  
  .btn-sm {
    padding: 0.5rem 1rem;
    font-size: 0.8rem;
  }
  
  .btn-lg {
    padding: 1rem 2rem;
    font-size: 1rem;
  }
  
  /* Checkbox Group */
  .checkbox-group {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin: 1rem 0;
  }
  
  .checkbox-group input[type="checkbox"] {
    width: 1.2rem;
    height: 1.2rem;
    margin: 0;
  }
  
  /* Preview Box */
  .preview-box {
    background: #f9fafb;
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 1rem;
    font-size: 0.875rem;
    color: var(--text-primary);
    min-height: 120px;
    white-space: pre-wrap;
  }
  
  .preview-box a {
    color: var(--secondary-blue);
    text-decoration: underline;
  }
  
  /* Table Styles */
  .table-container {
    overflow-x: auto;
    border-radius: 8px;
    border: 1px solid var(--border);
  }
  
  .table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.875rem;
  }
  
  .table th {
    background: #f9fafb;
    padding: 0.75rem 1rem;
    text-align: left;
    font-weight: 600;
    color: var(--text-primary);
    border-bottom: 1px solid var(--border);
  }
  
  .table td {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--border);
    vertical-align: top;
  }
  
  .table tr:hover {
    background: #f9fafb;
  }
  
  /* Badges */
  .badge {
    display: inline-flex;
    align-items: center;
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 600;
  }
  
  .badge-sms {
    background: #ecfeff;
    color: #0369a1;
  }
  
  .badge-email {
    background: #eef2ff;
    color: #3730a3;
  }
  
  /* Filters */
  .filters {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
  }
  
  .filter-group {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  .filter-group label {
    margin: 0;
    font-size: 0.875rem;
  }
  
  .filter-group select {
    padding: 0.5rem;
    border: 1px solid var(--border);
    border-radius: 6px;
    background: white;
    font-size: 0.875rem;
  }
  
  /* Responsive */
  @media (max-width: 768px) {
    .form-grid {
      grid-template-columns: 1fr;
    }
    
    .header-content {
      flex-direction: column;
      gap: 1rem;
      align-items: flex-start;
    }
    
    .nav-tabs .container {
      overflow-x: auto;
      padding-bottom: 0.5rem;
    }
    
    .nav-tab {
      white-space: nowrap;
      padding: 0.75rem 1rem;
    }
  }
  
  /* Footer */
  .footer-logo {
    margin-top: 3rem;
    text-align: center;
    padding: 1rem;
  }
  
  .footer-logo img {
    height: 40px;
    opacity: 0.85;
    transition: opacity 0.3s ease;
  }
  
  .footer-logo img:hover {
    opacity: 1;
  }
  
  /* Loading states */
  .loading {
    color: var(--text-secondary);
    text-align: center;
    padding: 2rem;
  }
  
  /* Empty states */
  .empty-state {
    text-align: center;
    padding: 3rem 1rem;
    color: var(--text-secondary);
  }
  
  .empty-state h3 {
    margin-bottom: 0.5rem;
    color: var(--text-primary);
  }
  </style>
  <style>
  /* AI Panel Styles */
  .send-layout { display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem; align-items: start; }
  .ai-panel { position: sticky; top: 92px; background: rgba(255,255,255,0.92); border: 1px solid var(--border); border-radius: 14px; box-shadow: 0 8px 24px rgba(2,6,23,0.12); overflow: hidden; backdrop-filter: blur(6px); }
  .ai-panel-header { display:flex; align-items:center; justify-content: space-between; padding: 1rem 1.25rem; border-bottom: 1px solid var(--border); background: radial-gradient(120% 120% at 100% 0%, #eef2ff 0%, #ffffff 50%, #f8fafc 100%); }
  .ai-title { font-weight: 800; color: var(--dark-blue); display:flex; align-items:center; gap:.5rem; letter-spacing: .2px; }
  .ai-title .sparkle { color: #f59e0b; text-shadow: 0 0 8px rgba(245,158,11,.5); animation: sparkle 2.4s ease-in-out infinite; }
  @keyframes sparkle { 0%,100% { filter: drop-shadow(0 0 0 rgba(245,158,11,0)); } 50% { filter: drop-shadow(0 0 6px rgba(245,158,11,.7)); } }
  .ai-badge { font-size: .7rem; font-weight: 800; padding: .2rem .6rem; border-radius: 9999px; background: linear-gradient(180deg, rgba(59,130,246,.15), rgba(59,130,246,.08)); color: #1e3a8a; border: 1px solid rgba(59,130,246,.25); box-shadow: inset 0 1px 0 rgba(255,255,255,.4); }
  .ai-section { padding: 1rem 1.25rem; border-bottom: 1px dashed var(--border); }
  .ai-section:last-child { border-bottom: 0; }
  .ai-section h4 { font-size: .9rem; margin-bottom: .6rem; color: var(--text-primary); }
  .ai-row { display:flex; gap:.5rem; flex-wrap: wrap; align-items: center; }
  .ai-chip { display:inline-flex; align-items:center; gap:.4rem; padding: .35rem .6rem; border-radius: 9999px; font-size: .75rem; font-weight: 700; border:1px solid rgba(148,163,184,.35); background: linear-gradient(180deg, #f8fafc, #ffffff); color:#0f172a; box-shadow: 0 1px 0 rgba(255,255,255,.8) inset, 0 6px 16px rgba(2,6,23,.06); }
  .ai-chip.success { background: linear-gradient(180deg,#ecfdf5,#ffffff); border-color: #a7f3d0; color:#065f46; }
  .ai-chip.warn { background: linear-gradient(180deg,#fffbeb,#ffffff); border-color:#fde68a; color:#92400e; }
  .ai-chip.info { background: linear-gradient(180deg,#eff6ff,#ffffff); border-color:#bfdbfe; color:#1e3a8a; }
  .ai-controls { display:grid; grid-template-columns: 1fr 1fr; gap:.5rem; }
  .ai-controls select, .ai-controls input[type="range"] { width:100%; padding:.5rem; border:1px solid var(--border); border-radius:8px; background:white; font-size:.85rem; }
  .ai-actions { display:flex; flex-wrap: wrap; gap:.5rem; margin-top:.5rem; }
  .btn-ghost { background:#ffffff; color:#1f2937; border:1px solid var(--border); }
  .btn-ghost:hover { background:#f3f4f6; }
  .ai-mini { font-size:.7rem; color:var(--text-secondary); }
  .ai-prediction { display:flex; align-items:center; gap:.4rem; font-size:.8rem; color:#065f46; background: linear-gradient(180deg,#ecfdf5,#ffffff); border:1px solid #a7f3d0; padding:.35rem .6rem; border-radius:9999px; font-weight:800; box-shadow: 0 8px 24px rgba(16,185,129,.15); animation: pulse 3s ease-in-out infinite; }
  @keyframes pulse { 0%,100% { transform: translateZ(0); box-shadow: 0 8px 24px rgba(16,185,129,.12);} 50% { box-shadow: 0 12px 32px rgba(16,185,129,.28);} }
  .ai-variant { border:1px solid var(--border); border-radius:10px; padding:.6rem .75rem; background:#fafafa; }
  .ai-variant p { margin:.25rem 0 .5rem 0; font-size:.85rem; color:#111827; }
  .ai-why { font-size:.75rem; color:var(--text-secondary); }
  @media (max-width: 1024px) { .send-layout { grid-template-columns: 1fr; } .ai-panel { position: static; } }
  /* Enhance primary button for AI vibe */
  .btn-primary { background: radial-gradient(120% 120% at 100% 0%, #1e40af 0%, #1e3a8a 45%, #0b1020 100%); border: 1px solid rgba(30,58,138,.5); box-shadow: 0 10px 24px rgba(30,58,138,.35); }
  .btn-primary:hover { box-shadow: 0 14px 28px rgba(30,58,138,.45); }
  /* Toast notifications */
  .toast-container { position: fixed; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 1000; }
  .toast { min-width: 260px; max-width: 420px; padding: 12px 14px; border-radius: 10px; color: #0f172a; background: #ffffff; border: 1px solid #e5e7eb; box-shadow: 0 10px 24px rgba(15,23,42,0.15); display: flex; align-items: center; gap: 10px; opacity: 0; transform: translateY(8px); animation: toast-in 160ms ease forwards; }
  .toast.success { border-color: #bbf7d0; background: #f0fdf4; color: #14532d; }
  .toast.error { border-color: #fecaca; background: #fef2f2; color: #7f1d1d; }
  .toast.info { border-color: #dbeafe; background: #eff6ff; color: #1e3a8a; }
  .toast .toast-title { font-weight: 600; margin-right: 6px; }
  @keyframes toast-in { to { opacity: 1; transform: translateY(0); } }
  @keyframes toast-out { to { opacity: 0; transform: translateY(8px); } }
  </style>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-analytics-compat.js"></script>
  <script src="js/review-tracking.js"></script>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="container">
      <div class="header-content">
        <div class="logo-section">
          <img id="practiceLogo" src="logo.png" alt="Logo">
          <div id="practiceName" class="practice-name"></div>
        </div>
        <div class="header-actions">
          <button id="settingsBtn" class="btn btn-secondary btn-sm">Settings</button>
          <button id="logoutBtn" class="btn btn-secondary btn-sm">Log out</button>
        </div>
      </div>
    </div>
  </header>

  <!-- Navigation Tabs -->
  <nav class="nav-tabs">
    <div class="container">
      <button class="nav-tab active" data-tab="send">Send Review Request</button>
      <button class="nav-tab" data-tab="history">Delivery History</button>
    </div>
  </nav>

  <div class="container">
    <!-- AI Digest Card -->
    <div id="aiDigestCard" class="card" style="margin-bottom:1rem; display:none;">
      <div class="card-body" style="display:flex; gap:1rem; flex-wrap:wrap; align-items:center; justify-content:space-between;">
        <div style="display:flex; align-items:center; gap:.5rem; font-weight:700; color:#111827;">
          <span style="color:#f59e0b;">✦</span>
          <span>SignalSense AI Digest</span>
        </div>
        <div style="display:flex; gap:.75rem; flex-wrap:wrap;">
          <span class="ai-chip" id="digestTotal">7d sends: —</span>
          <span class="ai-chip" id="digestSplit">SMS — / Email —</span>
          <span class="ai-chip" id="digestBestTime">Best time: —</span>
          <span class="ai-chip" id="digestAnomaly" style="display:none;" title="Volume is below typical range">Anomaly detected</span>
        </div>
      </div>
    </div>
    <div id="pwReminder" style="display:none; margin: 16px 0; padding: 12px 16px; border:1px solid #f59e0b; background:#fffbeb; color:#92400e; border-radius:8px;">
      You're using a temporary password. You can continue using it, but we recommend updating it in your profile.
      <div style="margin-top:8px; display:flex; gap:8px;">
        <button id="goToProfileBtn" class="btn btn-secondary btn-sm">Go to Profile</button>
        <button id="dismissPwReminderBtn" class="btn btn-secondary btn-sm">Dismiss</button>
      </div>
    </div>
    <!-- Send Review Request Tab -->
    <div id="send-tab" class="tab-content active">
      <div class="card">
        <div class="card-header">
          <h2>Send Review Request</h2>
        </div>
        <div class="card-body">
          <div id="headerText" class="loading">Loading...</div>
          <div class="send-layout">
            <div>
            <form id="patientForm">
            <div class="form-grid">
              <div class="form-group">
                <label for="fullName">Patient Full Name</label>
                <input type="text" id="fullName" name="fullName" required>
              </div>

              <div class="form-group">
                <label for="preferredName">Preferred Name</label>
                <input type="text" id="preferredName" name="preferredName">
              </div>

              <div class="form-group">
                <label for="phone">Phone Number</label>
                <input type="tel" id="phone" name="phone" placeholder="5551234567">
              </div>

              <div class="form-group">
                <label for="email">Email Address</label>
                <input type="email" id="email" name="email">
              </div>

              <div class="form-group full">
                <label for="message">Custom Message</label>
                <textarea id="message" name="message" rows="8" placeholder="Your message will go here..."></textarea>
              </div>

              <div class="form-group full">
                <label>Message Preview</label>
                <div id="messagePreview" class="preview-box"></div>
              </div>

              <div class="form-group full">
                <div class="checkbox-group">
                  <input type="checkbox" id="sendText" name="sendText">
                  <label for="sendText">Send Text Message</label>
                </div>
                <div class="checkbox-group">
                  <input type="checkbox" id="sendEmail" name="sendEmail">
                  <label for="sendEmail">Send Email</label>
                </div>
                <div style="display:flex; align-items:center; gap:.5rem; flex-wrap:wrap; margin-top:.25rem;">
                  <span class="ai-chip info" id="channelRecommendation" style="display:none;">Recommended: —</span>
                  <button type="button" id="applyChannelRecommendation" class="btn btn-ghost btn-sm" style="display:none;">Apply</button>
                </div>
              </div>

              <div class="form-group full" style="display:flex; gap:.75rem; align-items:center; flex-wrap: wrap;">
                <button type="submit" class="btn btn-primary btn-lg">Send Message</button>
                <span id="aiPredictedImpact" class="ai-prediction" style="display:none;">
                  <span>↑</span><span id="aiPredictedImpactText">Predicted +12–18% response</span>
                </span>
              </div>
            </div>
          </form>
            </div>
            <aside class="ai-panel" aria-label="AI Suggestions">
              <div class="ai-panel-header">
                <div class="ai-title"><span class="sparkle">✦</span><span>SignalSense AI</span></div>
                <span class="ai-badge">BETA</span>
              </div>
              <div class="ai-section">
                <h4>Message quality</h4>
                <div class="ai-row" id="aiQualityChips">
                  <span class="ai-chip info" id="chipTone">Tone: —</span>
                  <span class="ai-chip success" id="chipCompliance">No PHI detected</span>
                  <span class="ai-chip info" id="chipConfidence">AI confidence: —</span>
                </div>
                <div class="ai-mini" id="aiQualityNote" style="margin-top:.4rem;">Updates as you edit.</div>
              </div>
              <div class="ai-section">
                <h4>Copy studio</h4>
                <div class="ai-controls" style="margin-bottom:.5rem;">
                  <select id="aiTone">
                    <option value="warm">Warm</option>
                    <option value="professional">Professional</option>
                    <option value="friendly">Friendly</option>
                    <option value="direct">Direct</option>
                  </select>
                  <select id="aiLength">
                    <option value="short">Short</option>
                    <option value="medium" selected>Medium</option>
                    <option value="long">Long</option>
                  </select>
                  <select id="aiLanguage">
                    <option value="en" selected>English</option>
                    <option value="es">Español</option>
                  </select>
                </div>
                <div class="ai-actions">
                  <button type="button" id="btnAiGenerate" class="btn btn-secondary btn-sm">Generate with AI</button>
                  <button type="button" id="btnAiImprove" class="btn btn-ghost btn-sm">Improve clarity</button>
                  <button type="button" id="btnAiShorten" class="btn btn-ghost btn-sm">Shorten</button>
                  <button type="button" id="btnAiWarm" class="btn btn-ghost btn-sm">Make warmer</button>
                  <button type="button" id="btnQrPoster" class="btn btn-ghost btn-sm">QR Poster</button>
            <button type="button" id="btnCheckExpired" class="btn btn-ghost btn-sm">Check Expired Links</button>
                </div>
              </div>
              <div class="ai-section">
                <h4>Best send time</h4>
                <div class="ai-row">
                  <span id="aiBestTime" class="ai-chip">Calculating…</span>
                </div>
                <div class="ai-why" id="aiBestTimeWhy" style="margin-top:.4rem;">Based on recent engagement.</div>
              </div>
              <div class="ai-section" style="display:flex; align-items:center; justify-content:space-between;">
                <span class="ai-mini">Powered by SignalSense AI</span>
                <a class="ai-mini" href="docs/SignalSense-Patient-Feedback-Intelligence.md" target="_blank" rel="noopener">Learn more</a>
              </div>
            </aside>
          </div>
        </div>
      </div>
    </div>

    <!-- Delivery History Tab -->
    <div id="history-tab" class="tab-content">
      <div class="card">
        <div class="card-header">
          <h2>Recent Deliveries</h2>
        </div>
        <div class="card-body">
          <div class="card" style="margin-bottom:1rem;">
            <div class="card-body">
              <div style="display:flex; align-items:center; justify-content:space-between; gap:1rem; flex-wrap:wrap;">
                <strong>AI Reply Assistant</strong>
                <div class="ai-mini">Paste a new review to draft a courteous response</div>
              </div>
              <div style="margin-top:.5rem; display:grid; grid-template-columns: 1fr auto; gap:.5rem;">
                <textarea id="reviewInput" placeholder="Paste review text…" rows="3" style="min-height:80px;"></textarea>
                <div style="display:flex; gap:.5rem; align-items:start;">
                  <button type="button" id="btnDraftReply" class="btn btn-secondary btn-sm">Draft reply</button>
                </div>
              </div>
              <div id="replyOutput" class="preview-box" style="margin-top:.5rem; display:none;"></div>
            </div>
          </div>
          <div class="filters">
            <div class="filter-group">
              <label for="channelFilter">Channel:</label>
              <select id="channelFilter">
                <option value="all">All</option>
                <option value="sms">SMS</option>
                <option value="email">Email</option>
              </select>
            </div>
          </div>
          
          <div class="table-container">
            <table class="table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Patient</th>
                  <th>Channel</th>
                  <th>To</th>
                  <th>Message</th>
                </tr>
              </thead>
              <tbody id="deliveriesBody">
                <tr><td colspan="5" class="loading">Loading…</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="footer-logo">
    <a href="https://biminiai.com" target="_blank" rel="noopener">
      <img src="biminilogo.png" alt="Bimini Logo">
    </a>
  </footer>

  <!-- Toast Container -->
  <div id="toastContainer" class="toast-container" aria-live="polite" aria-atomic="true"></div>

  <!-- QR Poster Modal -->
  <div id="qrModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:1000; align-items:center; justify-content:center;">
    <div style="background:#fff; border-radius:12px; padding:1rem; width:min(92vw,560px); box-shadow:0 10px 30px rgba(0,0,0,.2);">
      <div style="display:flex; align-items:center; justify-content:space-between;">
        <strong>Create QR Poster</strong>
        <button id="qrClose" class="btn btn-ghost btn-sm">Close</button>
      </div>
      <div style="margin-top:.75rem; display:grid; grid-template-columns: 1fr 1fr; gap:1rem;">
        <div>
          <div id="qrImageWrap" style="display:flex; align-items:center; justify-content:center; background:#f9fafb; border:1px solid var(--border); border-radius:8px; padding:1rem; min-height:220px;">
            <img id="qrImage" alt="QR Code" style="max-width:100%; height:auto;"/>
          </div>
        </div>
        <div>
          <label>Headline</label>
          <input id="qrHeadline" value="Leave us a quick review"/>
          <label style="margin-top:.5rem; display:block;">Subtext</label>
          <input id="qrSubtext" value="Scan the code. It takes ~30 seconds."/>
          <div style="margin-top:.75rem; display:flex; gap:.5rem;">
            <a id="qrDownload" class="btn btn-primary btn-sm" download="review-qr.png">Download PNG</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Copilot drawer -->
  <style>
    .copilot-overlay { position: fixed; inset:0; background: rgba(2,6,23,.5); display:none; align-items: stretch; justify-content: flex-end; z-index: 1100; }
    .copilot-panel { width:min(92vw, 560px); background: linear-gradient(180deg,#0b1220,#0b1220 40%,#0f172a); color:#e5e7eb; border-left: 1px solid rgba(59,130,246,.25); box-shadow: -10px 0 30px rgba(0,0,0,.4); display:flex; flex-direction:column; }
    .copilot-header { display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid rgba(59,130,246,.2); background: linear-gradient(90deg, rgba(30,58,138,.25), rgba(30,58,138,0)); }
    .copilot-header .title { display:flex; align-items:center; gap:.5rem; font-weight:800; color:#fff; }
    .copilot-header .badge { font-size:.7rem; padding:.15rem .45rem; border-radius:9999px; background: rgba(59,130,246,.15); color:#bfdbfe; border:1px solid rgba(191,219,254,.2); }
    .copilot-body { padding: 12px; display:flex; flex-direction:column; gap:.75rem; height: 70vh; overflow-y:auto; }
    .chat-msg { display:flex; gap:.5rem; }
    .chat-bubble { max-width: 85%; padding:.65rem .8rem; border-radius:14px; font-size:.92rem; line-height:1.35rem; }
    .chat-user { justify-content:flex-end; }
    .chat-user .chat-bubble { background:#1f2937; color:#f9fafb; border:1px solid rgba(148,163,184,.25); border-bottom-right-radius:4px; }
    .chat-assistant .chat-bubble { background: linear-gradient(180deg, rgba(59,130,246,.12), rgba(59,130,246,.06)); color:#e5e7eb; border:1px solid rgba(59,130,246,.25); border-bottom-left-radius:4px; }
    .typing { display:inline-flex; gap:3px; align-items:center; }
    .dot { width:6px; height:6px; background:#93c5fd; border-radius:9999px; opacity:.6; animation: blink 1.2s infinite; }
    .dot:nth-child(2){ animation-delay:.2s; } .dot:nth-child(3){ animation-delay:.4s; }
    @keyframes blink { 0%, 60%, 100% { opacity:.2; } 30% { opacity:1; } }
    .copilot-suggestions { display:flex; flex-wrap:wrap; gap:.5rem; }
    .suggestion { font-size:.8rem; padding:.45rem .6rem; border-radius:9999px; border:1px solid rgba(148,163,184,.3); color:#cbd5e1; background:#0b1220; cursor:pointer; }
    .copilot-input { padding: 12px; border-top:1px solid rgba(59,130,246,.2); display:grid; grid-template-columns: 1fr auto; gap:.5rem; }
    .copilot-input textarea { width:100%; min-height:48px; max-height:140px; resize:vertical; border-radius:10px; border:1px solid rgba(148,163,184,.3); background:#0b1220; color:#e5e7eb; padding:.6rem .7rem; }
    .copilot-input .actions { display:flex; gap:.5rem; align-items:flex-start; }
    .btn-send { background:#1e40af; color:#fff; border:1px solid rgba(59,130,246,.5); border-radius:10px; padding:.6rem .9rem; font-weight:700; cursor:pointer; }
    .btn-insert { background:#111827; color:#cbd5e1; border:1px solid rgba(148,163,184,.35); border-radius:10px; padding:.6rem .9rem; cursor:pointer; }
  </style>
  <div id="copilotOverlay" class="copilot-overlay" role="dialog" aria-modal="true" aria-labelledby="copilotTitle">
    <div class="copilot-panel">
      <div class="copilot-header">
        <div class="title" id="copilotTitle"><span class="sparkle">✦</span> SignalSense Copilot</div>
        <span class="badge">GPT‑style</span>
        <button id="closeCopilot" class="btn btn-ghost btn-sm">Close</button>
      </div>
      <div class="copilot-body" id="copilotBody">
        <div class="copilot-suggestions" id="copilotSuggestions">
          <div class="suggestion" data-prompt="Draft a warm, short review ask for today’s cataract post‑op">Cataract post‑op (warm, short)</div>
          <div class="suggestion" data-prompt="Improve clarity and shorten my current message">Improve & shorten current</div>
          <div class="suggestion" data-prompt="Translate my message to Spanish with a friendly tone">Translate to Spanish</div>
          <div class="suggestion" data-prompt="Suggest the best send time today and why">Best send time</div>
        </div>
      </div>
      <div class="copilot-input">
        <textarea id="copilotPrompt" placeholder="Ask anything—e.g., ‘Draft a friendly, 2‑sentence review ask for retina injections’." ></textarea>
        <div class="actions">
          <button id="copilotSend" class="btn-send">Send</button>
          <button id="copilotInsert" class="btn-insert" title="Insert last AI draft into message">Insert into Message</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Script -->
  <script>
   document.addEventListener("DOMContentLoaded", function () {
  const firebaseConfig = {
    apiKey: "AIzaSyD20NR1jIBq_L3znffAe8c82VH49NcMmeE",
    authDomain: "ezreview-ee8f0.firebaseapp.com",
    projectId: "ezreview-ee8f0",
    storageBucket: "ezreview-ee8f0.firebasestorage.app",
    messagingSenderId: "985522835249",
    appId: "1:985522835249:web:fda8bab4bac91fb898ea10",
    measurementId: "G-RBB28JDVJW"
  };

  firebase.initializeApp(firebaseConfig);
  firebase.analytics();
  const db = firebase.firestore();
  // Toast helper
  function showToast(message, variant = 'success', title = '') {
    try {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${variant}`;
      toast.innerHTML = `${title ? `<span class=\"toast-title\">${title}</span>` : ''}<span>${escapeHtml(message)}</span>`;
      container.appendChild(toast);
      const lifetimeMs = Math.max(2000, Math.min(6000, message.length * 60));
      setTimeout(() => {
        toast.style.animation = 'toast-out 180ms ease forwards';
        setTimeout(() => container.removeChild(toast), 200);
      }, lifetimeMs);
    } catch (e) { /* no-op */ }
  }
  

  let reviewLink = "";
  
  // Tab Navigation
  const tabs = document.querySelectorAll('.nav-tab');
  const tabContents = document.querySelectorAll('.tab-content');
  
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      const targetTab = tab.getAttribute('data-tab');
      
      // Remove active class from all tabs and contents
      tabs.forEach(t => t.classList.remove('active'));
      tabContents.forEach(content => content.classList.remove('active'));
      
      // Add active class to clicked tab and corresponding content
      tab.classList.add('active');
      document.getElementById(`${targetTab}-tab`).classList.add('active');
    });
  });

 // Preferred name behavior
 const preferredNameInput = document.getElementById("preferredName");
const messageBox = document.getElementById("message");

const messagePreview = document.getElementById("messagePreview");

function escapeHtml(unsafe) {
  return unsafe
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/\"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

// 🔁 Extract message generation into reusable function
function updateMessageWithPreferredName() {
  const fullNameInput = document.getElementById('fullName');
  const computedName = (preferredNameInput.value.trim() || (fullNameInput?.value.trim() || '')) || "[preferred name]";
  const senderDisplay = (typeof profileSenderDisplay !== 'undefined' && profileSenderDisplay) ? profileSenderDisplay : (typeof profileSenderName !== 'undefined' && profileSenderName ? profileSenderName : 'Your team');

  let defaultMessage = `Hi ${computedName}!

We’re so grateful for the opportunity to take care of you. It would mean a lot to us if you shared your story by using the link below to leave feedback on Google.`;

  if (reviewLink) {
    // Show user-friendly text in message box, but we'll handle the actual URL during sending
    defaultMessage += `\n\nPlease leave us a review: [Click here to leave a review]`;
  }

  defaultMessage += `

Thanks!
${senderDisplay}`;

  const isAutoGenerated = (
    messageBox.value === "" ||
    (messageBox.value.startsWith("Hi ") && messageBox.value.includes("It would mean a lot to us if you shared your story"))
  );

  if (isAutoGenerated) {
    messageBox.value = defaultMessage;
  } else {
    // Only update the greeting name if the message appears to be the auto-generated style
    if (messageBox.value.includes("Hi ") && messageBox.value.includes("It would mean a lot to us if you shared your story")) {
      messageBox.value = messageBox.value.replace(/^Hi .*!/m, `Hi ${computedName}!`);
    }
  }

  updateMessagePreview();  // ✅ Fix: refresh preview after programmatic message update
}

// Helper function to add 5-star pre-selection to review links
function add5StarToReviewLink(reviewLink) {
    if (!reviewLink) return reviewLink;
    
    // If it already has a rating parameter, update it to 5
    if (reviewLink.includes('rating=')) {
        return reviewLink.replace(/rating=\d+/, 'rating=5');
    }
    
    // Handle Google search URLs with lrd parameter (Google Reviews)
    if (reviewLink.includes('google.com/search') && reviewLink.includes('lrd=')) {
        // Extract the place ID from the lrd parameter
        const lrdMatch = reviewLink.match(/lrd=([^,]+)/);
        if (lrdMatch) {
            const placeId = lrdMatch[1];
            // Convert to Google Reviews write review URL with 5-star pre-selection
            return `https://search.google.com/local/writereview?placeid=${placeId}&rating=5`;
        }
    }
    
    // If it's a Google Reviews URL, add rating parameter
    if (reviewLink.includes('search.google.com/local/writereview')) {
        const separator = reviewLink.includes('?') ? '&' : '?';
        return `${reviewLink}${separator}rating=5`;
    }
    
    // For other URLs, return as is (but could be enhanced later)
    return reviewLink;
}

// 📤 Live preview with link formatting
messageBox.addEventListener("input", updateMessagePreview);

function updateMessagePreview() {
  // Build an effective preview message that mirrors send-time logic
  const fiveStarPreviewLink = reviewLink ? add5StarToReviewLink(reviewLink) : null;
  let baseText = messageBox.value;

  // If user hasn't included the placeholder or a direct URL, append the friendly link line
  if (fiveStarPreviewLink) {
    const hasPlaceholder = baseText.includes('[Click here to leave a review]');
    const hasUrl = baseText.includes(fiveStarPreviewLink) || baseText.includes(reviewLink);
    if (!hasPlaceholder && !hasUrl) {
      baseText = `${baseText}\n\nPlease leave us a review: [Click here to leave a review]`;
    }
  }

  // Determine the correct public host for links (avoid localhost in outgoing emails/SMS)
  function getPublicHost() {
    try {
      const isLocal = ['localhost', '127.0.0.1'].includes(window.location.hostname);
      // Allow override via global if needed, e.g., window.PUBLIC_HOST = 'https://yourdomain.com'
      const configured = (typeof window !== 'undefined' && window.PUBLIC_HOST) ? window.PUBLIC_HOST : null;
      if (configured) return configured;
      if (isLocal) return 'https://ezreview-ee8f0.web.app';
      return window.location.origin;
    } catch {
      return window.location.origin;
    }
  }

  // Replace placeholder with a unique marker that won't be escaped
  let previewText = baseText;
  if (fiveStarPreviewLink) {
    previewText = previewText.replace(/\[Click here to leave a review\]/g, '___REVIEW_LINK_PLACEHOLDER___');
  }

  // Now escape the HTML for the rest of the content
  previewText = escapeHtml(previewText);

  // Replace any other URLs with clickable links
  const urlRegex = /(https?:\/\/[^\s]+)/g;
  previewText = previewText.replace(urlRegex, function(url) {
    const safeUrl = escapeHtml(url);
    if (url.includes('google.com') && (url.includes('review') || url.includes('writereview') || url.includes('lrd=') || url.includes('search?q=') || url.includes('local/writereview'))) {
      return '<a href="' + safeUrl + '" target="_blank" rel="noopener noreferrer" style="color: #1e3a8a; text-decoration: underline; font-weight: 500;">Click here to leave a review</a>';
    } else {
      return '<a href="' + safeUrl + '" target="_blank" rel="noopener noreferrer" style="color: #1e3a8a; text-decoration: underline;">' + safeUrl + '</a>';
    }
  });

  // Finally replace the unique marker with the actual HTML link (use 5-star link)
  if (fiveStarPreviewLink) {
    const safeUrl = escapeHtml(fiveStarPreviewLink);
    const linkHtml = '<a href="' + safeUrl + '" target="_blank" rel="noopener noreferrer" style="color: #1e3a8a; text-decoration: underline; font-weight: 500;">Click here to leave a review</a>';
    previewText = previewText.replace(/___REVIEW_LINK_PLACEHOLDER___/g, linkHtml);
  }

  messagePreview.innerHTML = previewText.replace(/\n/g, "<br>");
}

preferredNameInput.addEventListener("input", updateMessageWithPreferredName);
     
  // ===== AI Panel Logic =====
  const chipTone = document.getElementById('chipTone');
  const chipReading = document.getElementById('chipReading');
  const chipCompliance = document.getElementById('chipCompliance');
  const aiBestTime = document.getElementById('aiBestTime');
  const aiBestTimeWhy = document.getElementById('aiBestTimeWhy');
  const aiToneSel = document.getElementById('aiTone');
  const aiLengthSel = document.getElementById('aiLength');
  const aiLanguageSel = document.getElementById('aiLanguage');
  const btnAiGenerate = document.getElementById('btnAiGenerate');
  const btnAiImprove = document.getElementById('btnAiImprove');
  const btnAiShorten = document.getElementById('btnAiShorten');
  const btnAiWarm = document.getElementById('btnAiWarm');
  const aiPredictedImpact = document.getElementById('aiPredictedImpact');
  const aiPredictedImpactText = document.getElementById('aiPredictedImpactText');
  // simplified: removed variants UI
  const aiTokenUsage = document.getElementById('aiTokenUsage');

  function countSyllables(word) {
    try {
      word = word.toLowerCase();
      if (!word) return 0;
      const vowels = 'aeiouy';
      let syllables = 0;
      let prevVowel = false;
      for (let c of word) {
        const isVowel = vowels.includes(c);
        if (isVowel && !prevVowel) syllables++;
        prevVowel = isVowel;
      }
      if (word.endsWith('e')) syllables = Math.max(1, syllables - 1);
      return Math.max(1, syllables);
    } catch { return 1; }
  }

  // removed reading level estimator per request

  function estimateTone(text) {
    const t = text.toLowerCase();
    const warmSignals = ['thank you', 'thanks', 'appreciate', 'grateful', 'love to hear', 'means a lot'];
    const directSignals = ['review now', 'take a moment', 'please leave a review'];
    const exclaims = (text.match(/!/g) || []).length;
    const warmScore = warmSignals.reduce((s, k) => s + (t.includes(k) ? 1 : 0), 0) + (exclaims > 0 ? 1 : 0);
    const directScore = directSignals.reduce((s, k) => s + (t.includes(k) ? 1 : 0), 0);
    if (warmScore >= 2) return 'Warm';
    if (directScore >= 2) return 'Direct';
    if (t.includes('please')) return 'Professional';
    return 'Friendly';
  }

  function detectPHI(text) {
    const hasEmail = /\b[\w.+-]+@[\w-]+\.[\w.-]+\b/.test(text);
    const hasPhone = /\b\d{3}[-.\s]?\d{3}[-.\s]?\d{4}\b/.test(text);
    const hasDOB = /(dob|date of birth|\b\d{1,2}[\/.-]\d{1,2}[\/.-](\d{2,4}))\b/i.test(text);
    const hasMRN = /(mrn|medical record)/i.test(text);
    return hasEmail || hasPhone || hasDOB || hasMRN;
  }

  function updateQualityChips() {
    const text = messageBox.value || '';
    const tone = estimateTone(text);
    chipTone.textContent = `Tone: ${tone}`;
    const phi = detectPHI(text);
    chipCompliance.textContent = phi ? 'Possible PHI detected' : 'No PHI detected';
    chipCompliance.classList.toggle('warn', !!phi);
    chipCompliance.classList.toggle('success', !phi);
    // Confidence proxy: shorter + no PHI → higher
    const lengthPenalty = Math.min(50, (text.length / 20) | 0);
    const base = 95 - lengthPenalty - (phi ? 15 : 0);
    const confidence = Math.max(50, Math.min(98, base));
    const chipConf = document.getElementById('chipConfidence');
    if (chipConf) chipConf.textContent = `AI confidence: ${confidence}%`;
  }

  function randomImpact() {
    const min = 10, max = 20;
    const val = Math.round(min + Math.random() * (max - min));
    aiPredictedImpactText.textContent = `Predicted +${val}% response`;
    aiPredictedImpact.style.display = 'inline-flex';
  }

  function bestTimeHeuristic(deliveries) {
    if (!Array.isArray(deliveries) || deliveries.length < 10) {
      const now = new Date();
      const day = now.getDay(); // 0 Sun ... 6 Sat
      if (day === 0 || day === 6) return { label: '10:00–11:00 am', why: 'Weekend pattern heuristic' };
      return { label: '6:05–6:30 pm', why: 'Evening sends tend to perform better', dow: day };
    }
    const counts = new Array(24).fill(0);
    deliveries.forEach(d => {
      try {
        const dt = d.createdAt?.toDate ? d.createdAt.toDate() : new Date(d.createdAt);
        const h = dt.getHours();
        counts[h]++;
      } catch {}
    });
    let bestHour = 18; let bestCount = -1;
    counts.forEach((c, h) => { if (c > bestCount) { bestCount = c; bestHour = h; } });
    const pad = n => (n < 10 ? '0' + n : '' + n);
    const end = (bestHour + 1) % 24;
    const label = `${((bestHour + 11) % 12) + 1}:${pad(5)} ${(bestHour < 12) ? 'am' : 'pm'}–${((end + 11) % 12) + 1}:${pad(30)} ${(end < 12) ? 'am' : 'pm'}`;
    // Best day-of-week by volume
    const dowCounts = new Array(7).fill(0);
    deliveries.forEach(d => { try { const dt = d.createdAt?.toDate ? d.createdAt.toDate() : new Date(d.createdAt); dowCounts[dt.getDay()]++; } catch {} });
    let bestDow = 1, dowMax = -1; dowCounts.forEach((c,i)=>{ if (c>dowMax){ dowMax=c; bestDow=i; } });
    return { label, why: 'Recent send patterns', dow: bestDow };
  }

  function updateBestSendTime() {
    try {
      const { label, why } = bestTimeHeuristic(lastDeliveries || []);
      aiBestTime.textContent = label;
      aiBestTimeWhy.textContent = `Based on ${why}.`;
    } catch {
      aiBestTime.textContent = '6:05–6:30 pm';
      aiBestTimeWhy.textContent = 'Based on general patient engagement.';
    }
  }

  function buildGeneratedMessage({ tone, length }) {
    const fullNameInput = document.getElementById('fullName');
    const name = preferredNameInput.value.trim() || ((fullNameInput?.value || '').trim()) || 'there';
    const base = {
      warm: `Hi ${name},\n\nThank you for visiting us today. Your feedback helps other patients find great care. Would you mind sharing a quick review?\n\nPlease leave us a review: [Click here to leave a review]\n\nThanks so much,\nSarah`,
      professional: `Hello ${name},\n\nThank you for your visit. We value your experience and would appreciate a brief review of your care.\n\nLeave a review: [Click here to leave a review]\n\nSincerely,\nSarah`,
      friendly: `Hey ${name}!\n\nIt was great seeing you. If you have a minute, a quick review would really help others.\n\n[Click here to leave a review]\n\nThanks!\nSarah`,
      direct: `${name}, thanks for choosing us.\n\nCould you leave a quick review today? It takes ~30 seconds.\n\n[Click here to leave a review]\n\n— Sarah`
    };
    let msg = base[tone] || base.warm;
    if (length === 'short') {
      msg = msg.split(/\n\n/).slice(0, 2).join('\n\n') + `\n\n[Click here to leave a review]`;
    } else if (length === 'long') {
      msg += `\n\nWe read every comment and use your feedback to improve.`;
    }
    return msg;
  }

  function improveClarity(text) {
    let t = text.replace(/\s+!/g, '!').replace(/\s+/g, ' ');
    t = t.replace(/\bvery\s+/gi, '').replace(/\breally\s+/gi, '').trim();
    return t;
  }

  function shortenMessage(text) {
    const sentences = text.split(/(?<=[.!?])\s+/).filter(Boolean);
    const core = sentences.slice(0, 2).join(' ');
    return core.includes('[Click here to leave a review]') ? core : `${core}\n\n[Click here to leave a review]`;
  }

  function makeWarmer(text) {
    if (/thank/i.test(text)) return text;
    return text.replace(/\n\n([^]*)$/, '\n\nWe appreciate you taking the time.\\n$1');
  }

  // === Translation ===
  function preservePlaceholders(text) {
    return text.replace(/\[Click here to leave a review\]/g, '__REVIEW_LINK__');
  }
  function restorePlaceholders(text, lang) {
    // Keep placeholder English for system logic compatibility
    return text.replace(/__REVIEW_LINK__/g, '[Click here to leave a review]');
  }
  function translateEnToEs(text) {
    let t = preservePlaceholders(text);
    const map = [
      [/\bHi\b/gi, 'Hola'],
      [/\bHello\b/gi, 'Hola'],
      [/Thank you for visiting us today\.?/gi, 'Gracias por visitarnos hoy.'],
      [/Thank you so much for letting us take care of you\.?/gi, 'Muchas gracias por confiar en nosotros para su cuidado.'],
      [/Your feedback helps other patients find great care\.?/gi, 'Sus comentarios ayudan a otros pacientes a encontrar una excelente atención.'],
      [/Feedback is very valuable and we would love to hear from you\.?/gi, 'Su opinión es muy valiosa y nos encantaría conocerla.'],
      [/Would you mind sharing a quick review\??/gi, '¿Podría compartir una reseña rápida?'],
      [/Please leave us a review:?/gi, 'Por favor deje su reseña:'],
      [/Thanks so much,?/gi, 'Muchas gracias,'],
      [/Thanks,?/gi, 'Gracias,'],
      [/We value your perspective/gi, 'Valoramos su perspectiva'],
      [/a quick review would really help others/gi, 'una reseña rápida ayudaría a otros'],
    ];
    map.forEach(([re, rep]) => { t = t.replace(re, rep); });
    return restorePlaceholders(t, 'es');
  }
  function translateEsToEn(text) {
    let t = preservePlaceholders(text);
    const map = [
      [/\bHola\b/gi, 'Hi'],
      [/Gracias por visitarnos hoy\.?/gi, 'Thank you for visiting us today.'],
      [/Muchas gracias por confiar en nosotros para su cuidado\.?/gi, 'Thank you so much for letting us take care of you.'],
      [/Sus comentarios ayudan a otros pacientes a encontrar una excelente atención\.?/gi, 'Your feedback helps other patients find great care.'],
      [/Su opinión es muy valiosa y nos encantaría conocerla\.?/gi, 'Your feedback is very valuable and we would love to hear from you.'],
      [/¿Podría compartir una reseña rápida\??/gi, 'Would you mind sharing a quick review?'],
      [/Por favor deje su reseña:?/gi, 'Please leave us a review:'],
      [/Muchas gracias,?/gi, 'Thanks so much,'],
      [/Gracias,?/gi, 'Thanks,'],
    ];
    map.forEach(([re, rep]) => { t = t.replace(re, rep); });
    return restorePlaceholders(t, 'en');
  }
  function translateEnToPt(text) {
    let t = preservePlaceholders(text);
    const map = [
      [/\bHi\b/gi, 'Olá'],
      [/\bHello\b/gi, 'Olá'],
      [/Thank you for visiting us today\.?/gi, 'Obrigado por nos visitar hoje.'],
      [/Thank you so much for letting us take care of you\.?/gi, 'Muito obrigado por confiar em nossos cuidados.'],
      [/Your feedback helps other patients find great care\.?/gi, 'Seu feedback ajuda outros pacientes a encontrar um ótimo atendimento.'],
      [/Feedback is very valuable and we would love to hear from you\.?/gi, 'Seu feedback é muito valioso e adoraríamos ouvi-lo.'],
      [/Would you mind sharing a quick review\??/gi, 'Você poderia compartilhar uma avaliação rápida?'],
      [/Please leave us a review:?/gi, 'Por favor, deixe sua avaliação:'],
      [/Thanks so much,?/gi, 'Muito obrigado,'],
      [/Thanks,?/gi, 'Obrigado,'],
      [/We appreciate you taking the time\.?/gi, 'Agradecemos pelo seu tempo.'],
    ];
    map.forEach(([re, rep]) => { t = t.replace(re, rep); });
    return restorePlaceholders(t, 'pt');
  }
  function translateMessage(text, targetLang) {
    if (!text) return text;
    if (targetLang === 'en') return text; // leave as-is when switching to English
    if (targetLang === 'es') return translateEnToEs(text);
    return text;
  }
  function applyTransformKeepingLanguage(transform) {
    const targetLang = aiLanguageSel?.value || 'en';
    const newText = transform(messageBox.value || '');
    if (targetLang === 'en') return newText;
    return translateMessage(newText, targetLang);
  }

  function refreshVariants() { /* no-op after simplification */ }

  messageBox.addEventListener('input', () => { updateQualityChips(); refreshVariants(); });
  btnAiGenerate?.addEventListener('click', () => {
    const tone = aiToneSel.value || 'warm';
    const length = aiLengthSel.value || 'medium';
    const targetLang = aiLanguageSel?.value || 'en';
    let msg = buildGeneratedMessage({ tone, length });
    if (targetLang !== 'en') { msg = translateMessage(msg, targetLang); }
    messageBox.value = msg;
    updateMessagePreview(); updateQualityChips(); refreshVariants(); randomImpact();
    if (aiTokenUsage) aiTokenUsage.textContent = 'Tokens: ~0.2k';
  });
  btnAiImprove?.addEventListener('click', () => {
    messageBox.value = applyTransformKeepingLanguage(improveClarity);
    updateMessagePreview(); updateQualityChips(); refreshVariants(); randomImpact();
    if (aiTokenUsage) aiTokenUsage.textContent = 'Tokens: ~0.1k';
  });
  btnAiShorten?.addEventListener('click', () => {
    messageBox.value = applyTransformKeepingLanguage(shortenMessage);
    updateMessagePreview(); updateQualityChips(); refreshVariants(); randomImpact();
    if (aiTokenUsage) aiTokenUsage.textContent = 'Tokens: ~0.05k';
  });
  btnAiWarm?.addEventListener('click', () => {
    messageBox.value = applyTransformKeepingLanguage(makeWarmer);
    updateMessagePreview(); updateQualityChips(); refreshVariants(); randomImpact();
    if (aiTokenUsage) aiTokenUsage.textContent = 'Tokens: ~0.05k';
  });
  // removed variant apply handlers (simplified sidebar)

  aiLanguageSel?.addEventListener('change', () => {
    const targetLang = aiLanguageSel.value;
    const current = messageBox.value || '';
    let translated = translateMessage(current, targetLang);
    // If no visible change (e.g., custom text), regenerate from template in target language
    if (translated === current) {
      const tone = aiToneSel.value || 'warm';
      const length = aiLengthSel.value || 'medium';
      const base = buildGeneratedMessage({ tone, length });
      translated = translateMessage(base, targetLang);
    }
    messageBox.value = translated;
    updateMessagePreview(); updateQualityChips(); refreshVariants(); randomImpact();
  });

  // Initialize chips once DOM is ready
  setTimeout(() => { updateQualityChips(); refreshVariants(); updateBestSendTime(); }, 0);

  // AI Digest (7d) & Channel Recommendation
  const aiDigestCard = document.getElementById('aiDigestCard');
  const digestTotal = document.getElementById('digestTotal');
  const digestSplit = document.getElementById('digestSplit');
  const digestBestTime = document.getElementById('digestBestTime');
  const digestAnomaly = document.getElementById('digestAnomaly');
  const channelRecommendation = document.getElementById('channelRecommendation');
  const applyChannelRecommendation = document.getElementById('applyChannelRecommendation');

  function computeDigest(deliveries) {
    const now = Date.now();
    const weekAgo = now - 7 * 24 * 3600 * 1000;
    const last7 = deliveries.filter(d => {
      const ts = d.createdAt?.toDate ? d.createdAt.toDate().getTime() : new Date(d.createdAt).getTime();
      return ts >= weekAgo;
    });
    const total = last7.length;
    const sms = last7.filter(d => d.channel === 'sms').length;
    const email = last7.filter(d => d.channel === 'email').length;
    const best = bestTimeHeuristic(last7);
    digestTotal.textContent = `7d sends: ${total}`;
    digestSplit.textContent = `SMS ${sms} / Email ${email}`;
    digestBestTime.textContent = `Best time: ${best.label}`;
    digestAnomaly.style.display = total > 0 && total < 5 ? 'inline-flex' : 'none';
    aiDigestCard.style.display = 'block';

    // Channel recommendation: prefer SMS if SMS proportion < 60% and phone present; else Email
    const rec = sms < email ? 'SMS' : (email < sms ? 'Email' : 'Both');
    channelRecommendation.textContent = `Recommended: ${rec}`;
    channelRecommendation.style.display = 'inline-flex';
    applyChannelRecommendation.style.display = 'inline-flex';
    applyChannelRecommendation.onclick = () => {
      const smsBox = document.getElementById('sendText');
      const emailBox = document.getElementById('sendEmail');
      if (rec === 'SMS') { smsBox.checked = true; emailBox.checked = false; }
      else if (rec === 'Email') { smsBox.checked = false; emailBox.checked = true; }
      else { smsBox.checked = true; emailBox.checked = true; }
      showToast(`Applied channel: ${rec}`, 'info');
    };
  }

  // QR Poster modal logic
  const qrModal = document.getElementById('qrModal');
  const qrClose = document.getElementById('qrClose');
  const qrHeadline = document.getElementById('qrHeadline');
  const qrSubtext = document.getElementById('qrSubtext');
  const qrImage = document.getElementById('qrImage');
  const qrDownload = document.getElementById('qrDownload');
  const btnQrPoster = document.getElementById('btnQrPoster');

  function generateQRDataUrl(url, size = 512) {
    // Tiny QR via Google Chart API as a quick, dependency-free placeholder
    const encoded = encodeURIComponent(url);
    const qurl = `https://chart.googleapis.com/chart?cht=qr&chs=${size}x${size}&chl=${encoded}`;
    return qurl;
  }

  function buildPosterCanvas(url) {
    const canvas = document.createElement('canvas');
    canvas.width = 1200; canvas.height = 1600;
    const ctx = canvas.getContext('2d');
    // Background
    ctx.fillStyle = '#ffffff'; ctx.fillRect(0,0,canvas.width,canvas.height);
    // Header block
    ctx.fillStyle = '#1e3a8a'; ctx.fillRect(0,0,canvas.width,260);
    ctx.fillStyle = '#ffffff'; ctx.font = 'bold 64px Inter, Arial'; ctx.fillText(qrHeadline.value || 'Leave us a quick review', 60, 150);
    // Subtext
    ctx.fillStyle = '#1f2937'; ctx.font = '36px Inter, Arial';
    ctx.fillText(qrSubtext.value || 'Scan the code. It takes ~30 seconds.', 60, 330);
    // QR image
    return new Promise((resolve) => {
      const img = new Image();
      img.crossOrigin = 'anonymous';
      img.onload = () => {
        const qrSize = 800; const x = (canvas.width - qrSize) / 2; const y = 420;
        ctx.drawImage(img, x, y, qrSize, qrSize);
        // Footer
        ctx.fillStyle = '#6b7280'; ctx.font = '28px Inter, Arial';
        ctx.fillText('Point your camera at the QR to open our review page.', 60, 1500);
        resolve(canvas);
      };
      img.src = generateQRDataUrl(url, 512);
    });
  }

  btnQrPoster?.addEventListener('click', async () => {
    if (!reviewLink) { showToast('Set your review link in profile first.', 'info'); return; }
    qrModal.style.display = 'flex';
    qrImage.src = generateQRDataUrl(reviewLink, 256);
    qrDownload.href = '#';
    try {
      const canvas = await buildPosterCanvas(reviewLink);
      const dataUrl = canvas.toDataURL('image/png');
      qrDownload.href = dataUrl;
    } catch {}
  });

  // Add event listener for checking expired links
  const btnCheckExpired = document.getElementById('btnCheckExpired');
  btnCheckExpired?.addEventListener('click', checkAndResendExpiredLinks);
  qrClose?.addEventListener('click', () => { qrModal.style.display = 'none'; });
  qrModal?.addEventListener('click', (e) => { if (e.target === qrModal) qrModal.style.display = 'none'; });

  // Review Link Tracking and Auto-Resend
  async function checkAndResendExpiredLinks() {
    try {
      const now = new Date();
      const threeDaysAgo = new Date(now.getTime() - 1 * 60 * 1000);
      
      // Find all unclicked review links that are older than 3 days
      const expiredLinks = await db.collection('reviewTracking')
        .where('clicked', '==', false)
        .where('expiresAt', '<=', now)
        .where('resendCount', '<', 3) // Limit to 3 resends
        .get();
      
      if (expiredLinks.empty) {
        showToast('No expired review links found to resend.', 'info');
        return;
      }
      
      let resendCount = 0;
      for (const doc of expiredLinks.docs) {
        const tracking = doc.data();
        
        try {
          // Generate new tracking URL for the resend (reuse same tracking ID)
          const trackingUrl = `${window.location.origin}/tracking.html?tracking=${doc.id}&link=${encodeURIComponent(tracking.reviewLink)}`;
          
          // Resend the message with updated tracking URL
          if (tracking.channel === 'sms') {
            // Replace any existing tracking URLs or placeholders with new tracking URL
            let resendMessage = tracking.message;
            if (resendMessage.includes('[TRACKING_URL]')) {
              resendMessage = resendMessage.replace('[TRACKING_URL]', trackingUrl);
            } else if (resendMessage.includes('tracking.html?tracking=')) {
              // Replace existing tracking URL
              resendMessage = resendMessage.replace(/https?:\/\/[^\s]+\/tracking\.html\?tracking=[^\s]+/, trackingUrl);
            } else {
              // Append tracking URL if not present
              resendMessage = `${resendMessage}\n\nPlease leave us a review: ${trackingUrl}`;
            }
            
            const smsPayload = {
              to: tracking.to,
              body: resendMessage
            };
            await db.collection("messages").add(smsPayload);
          } else if (tracking.channel === 'email') {
            // For email, use the stored finalHtml if available, otherwise build from message
            let emailHtml = tracking.finalHtml;
            if (!emailHtml) {
              emailHtml = tracking.message.replace(/\n/g, '<br>');
            }
            
            // Replace tracking URLs in HTML
            if (emailHtml.includes('tracking.html?tracking=')) {
              emailHtml = emailHtml.replace(/href="[^"]*tracking\.html\?tracking=[^"]*"/g, `href="${trackingUrl}"`);
            } else {
              // Add tracking link if not present
              emailHtml += `<br><br><a href="${trackingUrl}" target="_blank" rel="noopener noreferrer" style="color: #1e3a8a; text-decoration: underline; font-weight: 500;">Click here to leave a review</a>`;
            }
            
            const mailPayload = {
              to: tracking.to,
              message: {
                subject: `We'd love your feedback! (Reminder)`,
                html: emailHtml
              }
            };
            await db.collection("mail").add(mailPayload);
          }
          
          // Update tracking record
          await doc.ref.update({
            resendCount: firebase.firestore.FieldValue.increment(1),
            lastResentAt: firebase.firestore.FieldValue.serverTimestamp(),
            expiresAt: new Date(Date.now() + 1 * 60 * 1000) // Reset expiration
          });
          
          resendCount++;
        } catch (error) {
          console.error('Failed to resend for tracking ID:', doc.id, error);
        }
      }
      
      showToast(`Successfully resent ${resendCount} review requests.`, 'success');
      
      // Refresh the deliveries display
      if (typeof loadDeliveries === 'function') {
        loadDeliveries();
      }
      
    } catch (error) {
      console.error('Error checking expired links:', error);
      showToast('Failed to check expired links: ' + error.message, 'error');
    }
  }

  // AI Reply Assistant
  const reviewInput = document.getElementById('reviewInput');
  const replyOutput = document.getElementById('replyOutput');
  const btnDraftReply = document.getElementById('btnDraftReply');
  function draftReply(text) {
    const politeOpeners = [
      'Thank you for taking the time to share your experience.',
      'We appreciate your feedback and the opportunity to care for you.',
      'Thanks for your review—your perspective helps us improve.'
    ];
    const closer = 'If there is anything more we can do, please reach out to our team.';
    const opener = politeOpeners[Math.floor(Math.random()*politeOpeners.length)];
    const positive = /(great|excellent|amazing|wonderful|thank)/i.test(text);
    const negative = /(wait|rude|bad|poor|late|pain|problem|issue)/i.test(text);
    let body;
    if (positive && !negative) {
      body = 'We are glad to hear your visit went well. Your kind words mean a lot to our team.';
    } else if (negative && !positive) {
      body = 'We are sorry to hear parts of your visit did not meet expectations. We are reviewing this with our team.';
    } else {
      body = 'We value your perspective and will share it with our team.';
    }
    return `${opener} ${body} ${closer}`;
  }
  btnDraftReply?.addEventListener('click', () => {
    const txt = (reviewInput.value || '').trim();
    if (!txt) { showToast('Paste a review first.', 'info'); return; }
    const draft = draftReply(txt);
    replyOutput.style.display = 'block';
    replyOutput.textContent = draft;
  });

  // === Copilot Drawer Logic ===
  const openCopilot = document.getElementById('openCopilot');
  const closeCopilot = document.getElementById('closeCopilot');
  const copilotOverlay = document.getElementById('copilotOverlay');
  const copilotBody = document.getElementById('copilotBody');
  const copilotPrompt = document.getElementById('copilotPrompt');
  const copilotSend = document.getElementById('copilotSend');
  const copilotInsert = document.getElementById('copilotInsert');
  const copilotSuggestions = document.getElementById('copilotSuggestions');
  let lastAIDraft = '';

  function openDrawer() { copilotOverlay.style.display = 'flex'; setTimeout(() => copilotPrompt.focus(), 50); }
  function closeDrawer() { copilotOverlay.style.display = 'none'; }
  openCopilot?.addEventListener('click', openDrawer);
  closeCopilot?.addEventListener('click', closeDrawer);
  copilotOverlay?.addEventListener('click', (e) => { if (e.target === copilotOverlay) closeDrawer(); });

  function renderAssistantMessage(html) {
    const wrap = document.createElement('div');
    wrap.className = 'chat-msg chat-assistant';
    wrap.innerHTML = `<div class="chat-bubble">${html}</div>`;
    copilotBody.appendChild(wrap);
    copilotBody.scrollTop = copilotBody.scrollHeight;
  }
  function renderUserMessage(text) {
    const wrap = document.createElement('div');
    wrap.className = 'chat-msg chat-user';
    const safe = escapeHtml(text);
    wrap.innerHTML = `<div class="chat-bubble">${safe}</div>`;
    copilotBody.appendChild(wrap);
    copilotBody.scrollTop = copilotBody.scrollHeight;
  }
  function renderTyping() {
    const wrap = document.createElement('div');
    wrap.className = 'chat-msg chat-assistant';
    wrap.innerHTML = `<div class="chat-bubble"><span class="typing"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span></div>`;
    copilotBody.appendChild(wrap);
    copilotBody.scrollTop = copilotBody.scrollHeight;
    return wrap;
  }

  function copilotDraftFromPrompt(prompt) {
    const fullNameInput = document.getElementById('fullName');
    const name = preferredNameInput.value.trim() || ((fullNameInput?.value || '').trim()) || 'there';
    const base = buildGeneratedMessage({ tone: 'warm', length: 'medium' });
    if (/translate.*spanish/i.test(prompt)) {
      return base
        .replace('Hi', 'Hola')
        .replace('Thank you for visiting us today.', 'Gracias por visitarnos hoy.')
        .replace('Your feedback helps other patients find great care.', 'Sus comentarios ayudan a otros pacientes a encontrar una excelente atención.')
        .replace('Would you mind sharing a quick review?', '¿Podría compartir una reseña rápida?')
        .replace('Please leave us a review:', 'Por favor deje su reseña:')
        .replace('Thanks so much,', 'Muchas gracias,');
    }
    if (/improve|shorten/i.test(prompt)) {
      return shortenMessage(improveClarity(messageBox.value || base));
    }
    if (/cataract|post\-?op|retina|injection/i.test(prompt)) {
      return `Hi ${name},\n\nThank you for your visit today. If you have a moment, a quick review would help other patients considering similar care.\n\n[Click here to leave a review]\n\nThanks,\nSarah`;
    }
    if (/best send time/i.test(prompt)) {
      const { label, why } = bestTimeHeuristic(lastDeliveries || []);
      return `Based on your recent sending pattern, today’s best window is ${label}. Reason: ${why}.`;
    }
    return base;
  }

  function sendCopilot() {
    const prompt = (copilotPrompt.value || '').trim();
    if (!prompt) return;
    renderUserMessage(prompt);
    const typing = renderTyping();
    setTimeout(() => {
      typing.remove();
      const draft = copilotDraftFromPrompt(prompt);
      lastAIDraft = draft;
      const html = escapeHtml(draft).replace(/\n/g, '<br>');
      renderAssistantMessage(html + '<div class="ai-mini" style="margin-top:.4rem; opacity:.8;">Use “Insert into Message” to apply</div>');
    }, 600 + Math.random()*600);
    copilotPrompt.value = '';
  }
  copilotSend?.addEventListener('click', sendCopilot);
  copilotPrompt?.addEventListener('keydown', (e) => { if (e.key === 'Enter' && (e.metaKey || e.ctrlKey)) sendCopilot(); });
  copilotInsert?.addEventListener('click', () => {
    if (!lastAIDraft) { showToast('No AI draft yet.', 'info'); return; }
    messageBox.value = lastAIDraft;
    updateMessagePreview(); updateQualityChips(); refreshVariants(); randomImpact();
    showToast('Inserted AI draft into message.', 'success');
  });
  copilotSuggestions?.addEventListener('click', (e) => {
    const el = e.target.closest('.suggestion');
    if (!el) return;
    copilotPrompt.value = el.getAttribute('data-prompt') || '';
    sendCopilot();
  });


  // 🔒 Enforce login and load user profile by UID
  let currentUser = null;
  let unsubscribeDeliveries = null;
  let lastDeliveries = [];
  // Settings pulled from profile
  let userEmailSubject = null;
  let profileSenderName = null; // e.g., "Your team"
  let profileSenderDisplay = null; // Friendly From name

  firebase.auth().onAuthStateChanged(async (user) => {
    if (!user) {
      console.warn("🔒 Not authenticated. Redirecting to login.");
      window.location.href = "index.html";
      return;
    }

    console.log("✅ Authenticated as:", user.email);
    currentUser = user;

    try {
      const qs = await db.collection("users").where("email", "==", user.email).limit(1).get();
      if (!qs.empty) {
        const data = qs.docs[0].data();
        try {
          const shouldShow = localStorage.getItem('showPwReminder') === '1' || data.needsPasswordChange === true;
          if (shouldShow) {
            const bar = document.getElementById('pwReminder');
            bar.style.display = 'block';
            document.getElementById('goToProfileBtn').onclick = () => { window.location.href = 'profile.html'; };
            document.getElementById('dismissPwReminderBtn').onclick = async () => {
              bar.style.display = 'none';
              try { localStorage.removeItem('showPwReminder'); } catch {}
            };
          }
        } catch {}
        reviewLink = data.reviewLink || "";
        console.log("✅ Review link loaded:", reviewLink);

        const senderName = data.senderName || 'Your team';
        profileSenderName = senderName;
        const fullName = data.fullName || data.fullname || user.email;
        document.getElementById("headerText").textContent = `Send a review request as ${senderName}`;

        // Practice name/logo if available
        if (data.logoUrl) {
          const img = document.getElementById('practiceLogo');
          img.src = data.logoUrl;
        }
        if (data.practiceName) {
          document.getElementById('practiceName').textContent = data.practiceName;
        }

        // 🔁 If profile is incomplete, send to profile setup
        if (!(data.fullName && data.reviewLink)) {
          window.location.href = "profile.html";
          return;
        }

        // Load default message/subject if provided
        const defaultMessage = data.defaultMessage || null;
        userEmailSubject = data.emailSubject || null;
        profileSenderDisplay = data.senderDisplay || data.senderName || null;
        if (defaultMessage) {
          const fullNameEl = document.getElementById('fullName');
          const preferred = preferredNameInput.value.trim();
          const full = (fullNameEl?.value || '').trim();
          const name = preferred || full || "[preferred name]";
          messageBox.value = defaultMessage.replaceAll('{name}', name);
        }
        // Refresh message and preview after profile data loads
        updateMessageWithPreferredName();
        updateMessagePreview();

        // Subscribe to recent deliveries
        subscribeToDeliveries();
        updateBestSendTime();
      } else {
        console.warn("⚠️ No profile found for email:", user.email);
        // If no profile doc exists, go to profile setup
        window.location.href = "profile.html";
        return;
      }
    } catch (err) {
      console.error("❌ Error loading user profile:", err);
      document.getElementById("headerText").textContent = `Review for: ${user.email}`;
    }
  });
  
  // Actions: logout and profile
  document.getElementById('logoutBtn').addEventListener('click', async () => {
    try { await firebase.auth().signOut(); } catch {}
    window.location.href = 'index.html';
  });
  document.getElementById('settingsBtn').addEventListener('click', () => {
    window.location.href = 'settings.html';
  });
     
  // --- Deliveries rendering ---
  function formatDate(ts) {
    try {
      if (!ts) return '-';
      const d = ts.toDate ? ts.toDate() : new Date(ts);
      return d.toLocaleString();
    } catch { return '-'; }
  }

  function truncate(text, n) {
    if (!text) return '';
    return text.length > n ? text.slice(0, n - 1) + '…' : text;
  }

  function renderDeliveries(items) {
    const tbody = document.getElementById('deliveriesBody');
    if (!items.length) {
      tbody.innerHTML = '<tr><td colspan="5" class="empty-state"><h3>No deliveries yet</h3><p>Your sent messages will appear here</p></td></tr>';
      return;
    }
    tbody.innerHTML = items.map(d => {
      const patient = d.patientPreferredName || d.patientFullName || '';
      const badgeClass = d.channel === 'sms' ? 'badge badge-sms' : 'badge badge-email';
      const toPretty = d.channel === 'sms' ? d.to.replace('+1','(*** )***-') : d.to;
      return `<tr>
        <td>${formatDate(d.createdAt)}</td>
        <td>${truncate(patient, 40)}</td>
        <td><span class="${badgeClass}">${d.channel.toUpperCase()}</span></td>
        <td>${truncate(toPretty, 40)}</td>
        <td>${truncate(d.message, 120)}</td>
      </tr>`;
    }).join('');
  }

  function subscribeToDeliveries() {
    const channelSel = document.getElementById('channelFilter');
    if (unsubscribeDeliveries) { unsubscribeDeliveries(); }
    unsubscribeDeliveries = db.collection('deliveries')
      .where('ownerEmail', '==', currentUser.email)
      .orderBy('createdAt', 'desc')
      .limit(50)
      .onSnapshot(snap => {
        lastDeliveries = snap.docs.map(doc => doc.data());
        const filtered = channelSel.value === 'all' ? lastDeliveries : lastDeliveries.filter(d => d.channel === channelSel.value);
        renderDeliveries(filtered);
        updateBestSendTime();
      }, err => {
        console.warn('Failed to load deliveries', err);
        renderDeliveries([]);
      });
    channelSel.addEventListener('change', () => {
      const filtered = channelSel.value === 'all' ? lastDeliveries : lastDeliveries.filter(d => d.channel === channelSel.value);
      renderDeliveries(filtered);
    });
  }

      document.getElementById("patientForm").addEventListener("submit", async function (e) {
        e.preventDefault();

        const phone = document.getElementById("phone").value.trim();
        const email = document.getElementById("email").value.trim();
        const preferredName = document.getElementById("preferredName").value.trim();
        const sendText = document.getElementById("sendText").checked;
        const sendEmail = document.getElementById("sendEmail").checked;
        let message = document.getElementById("message").value.trim();
        // Work on a mutable template copy derived from the current message
        let messageTemplate = message || "";

        if (!(sendText || sendEmail)) {
          showToast("Please select at least one delivery method (Text or Email).", 'info');
          return;
        }

        // Validate phone if texting
        if (sendText) {
          const digits = (phone || '').replace(/\D/g, '');
          if (digits.length !== 10) {
            showToast("Enter a valid 10-digit US phone number to send a text.", 'error', 'Invalid number');
            return;
          }
        }

        // Build message variants from the user's template
        const fiveStarReviewLink = reviewLink ? add5StarToReviewLink(reviewLink) : reviewLink;
        // Avoid duplicating names: only inject greeting name if no placeholder tokens are present
        const hasNamePlaceholder = messageTemplate.includes('{name}') || messageTemplate.includes('[preferred name]') || messageTemplate.includes('[Preferred name]') || messageTemplate.includes('[Preferred Name]') || messageTemplate.includes('[name]');
        if (!hasNamePlaceholder) {
          if (preferredName) {
            messageTemplate = messageTemplate.replace(/^Hi /i, `Hi ${preferredName}, `)
                                             .replace(/^Hello /i, `Hello ${preferredName}, `)
                                             .replace(/^Hey /i, `Hey ${preferredName}! `);
          } else {
            const fullName = document.getElementById('fullName').value.trim();
            if (fullName) {
              messageTemplate = messageTemplate.replace(/^Hi /i, `Hi ${fullName}, `)
                                               .replace(/^Hello /i, `Hello ${fullName}, `)
                                               .replace(/^Hey /i, `Hey ${fullName}! `);
            }
          }
        }

        // Replace placeholder tokens directly
        const displayName = (preferredName || document.getElementById('fullName').value.trim() || 'there');
        messageTemplate = messageTemplate
          .replace('[preferred name]', displayName)
          .replace('[Preferred name]', displayName)
          .replace('[Preferred Name]', displayName)
          .replace('{name}', displayName)
          .replace('{Name}', displayName);

        // SMS: prepare message template for tracking URL replacement
        let messageForSms = messageTemplate;
        if (reviewLink) {
          // We'll replace this with tracking URL after creating the tracking record
          if (messageTemplate.includes("[Click here to leave a review]")) {
            messageForSms = messageTemplate.replace("[Click here to leave a review]", "[TRACKING_URL]");
          } else if (messageTemplate.includes(fiveStarReviewLink) || messageTemplate.includes(reviewLink)) {
            // Keep the existing URL as-is
            messageForSms = messageTemplate.replace(reviewLink, "[TRACKING_URL]");
          } else {
            messageForSms = `${messageTemplate}\n\nPlease leave us a review: [TRACKING_URL]`;
          }
        }

        // Email: keep a plain text version for logging while HTML is built separately
        let messageForEmailText = messageTemplate;
        if (reviewLink && messageTemplate.includes("[Click here to leave a review]")) {
          messageForEmailText = messageTemplate.replace("[Click here to leave a review]", fiveStarReviewLink);
        } else if (reviewLink && !messageTemplate.includes(fiveStarReviewLink)) {
          messageForEmailText = `${messageTemplate}\n\nPlease leave us a review: ${fiveStarReviewLink}`;
        }

        try {
          if (sendText && phone && message) {
            let finalSmsMessage = messageForSms;
            let trackingRef = null;
            
            // Create tracking record FIRST if review link exists
            if (reviewLink) {
              try {
                trackingRef = await db.collection('reviewTracking').add({
                  ownerEmail: currentUser.email,
                  patientFullName: document.getElementById('fullName').value.trim(),
                  patientPreferredName: preferredName || '',
                  to: "+1" + phone.replace(/\D/g, ""),
                  channel: 'sms',
                  reviewLink: fiveStarReviewLink,
                  message: messageForSms, // Will store original template
                  sentAt: firebase.firestore.FieldValue.serverTimestamp(),
                  expiresAt: new Date(Date.now() + 1 * 60 * 1000), // 1 minute from now (for testing)
                  clicked: false,
                  clickCount: 0,
                  resendCount: 0,
                  lastResentAt: null,
                  senderName: (profileSenderDisplay || profileSenderName || '').trim() // Store sender name for resends
                });
                
                // Generate tracking URL
                const trackingUrl = `${getPublicHost()}/tracking.html?tracking=${trackingRef.id}&link=${encodeURIComponent(fiveStarReviewLink)}`;
                
                // Replace [TRACKING_URL] placeholder with actual tracking URL
                finalSmsMessage = messageForSms.replace('[TRACKING_URL]', trackingUrl);
                
                console.log("✅ Created tracking record:", trackingRef.id);
                console.log("🔗 Generated tracking URL:", trackingUrl);
              } catch (e) {
                console.warn('Failed to create tracking record, sending without tracking:', e);
                // Fallback: replace with direct link
                finalSmsMessage = messageForSms.replace('[TRACKING_URL]', fiveStarReviewLink);
              }
            } else {
              // No review link, remove placeholder
              console.log("❌ No review link found - tracking will not be created");
              finalSmsMessage = messageForSms.replace('[TRACKING_URL]', '');
            }
            
            const smsPayload = {
              to: "+1" + phone.replace(/\D/g, ""),
              body: finalSmsMessage
            };
            console.log("📱 Sending SMS:", smsPayload);
            try {
              await db.collection("messages").add(smsPayload);
            } catch (err) {
              console.error('Failed to queue SMS:', err);
              showToast("Failed to queue text: " + (err.message || ''), 'error', 'Error');
              throw err;
            }
            
            // Log delivery record
            try {
              const deliveryRef = await db.collection('deliveries').add({
                ownerEmail: currentUser.email,
                patientFullName: document.getElementById('fullName').value.trim(),
                patientPreferredName: preferredName || '',
                to: smsPayload.to,
                channel: 'sms',
                message: finalSmsMessage,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                trackingId: trackingRef ? trackingRef.id : null
              });
              
              // Update tracking record with delivery ID
              if (trackingRef) {
                await trackingRef.update({
                  deliveryId: deliveryRef.id,
                  finalMessage: finalSmsMessage // Store the final message with tracking URL
                });
              }
            } catch (e) { console.warn('Failed to log SMS delivery', e); }
            showToast("Text message queued for delivery.", 'success', 'Sent');
          }

          if (sendEmail && email && message) {
            let finalEmailMessage = messageForEmailText;
            let emailTrackingRef = null;
            let trackingUrl = null;
            
            // Create tracking record FIRST if review link exists
            if (reviewLink) {
              console.log("🔗 Review link found, creating tracking record...", reviewLink);
              try {
                console.log("📝 Creating email tracking record...");
                emailTrackingRef = await db.collection('reviewTracking').add({
                  ownerEmail: currentUser.email,
                  patientFullName: document.getElementById('fullName').value.trim(),
                  patientPreferredName: preferredName || '',
                  to: email,
                  channel: 'email',
                  reviewLink: fiveStarReviewLink,
                  message: messageForEmailText, // Will store original template
                  sentAt: firebase.firestore.FieldValue.serverTimestamp(),
                  expiresAt: new Date(Date.now() + 1 * 60 * 1000), // 1 minute from now (for testing)
                  clicked: false,
                  clickCount: 0,
                  resendCount: 0,
                  lastResentAt: null,
                  senderName: (profileSenderDisplay || profileSenderName || '').trim() // Store sender name for resends
                });
                
                // Generate tracking URL
                trackingUrl = `${getPublicHost()}/tracking.html?tracking=${emailTrackingRef.id}&link=${encodeURIComponent(fiveStarReviewLink)}`;
                
                console.log("✅ Created email tracking record:", emailTrackingRef.id);
                console.log("🔗 Generated email tracking URL:", trackingUrl);
                console.log("📧 About to send email with tracking...");
              } catch (e) {
                console.warn('Failed to create email tracking record, sending without tracking:', e);
                trackingUrl = fiveStarReviewLink; // Fallback to direct link
              }
            } else {
              console.log("❌ No review link found for email - tracking will not be created");
            }
            
            // Build HTML email content with tracking links
            let htmlTemplate = messageTemplate;
            
            // If email body lacks the placeholder or direct link, append a friendly link line  
            if (reviewLink && !messageTemplate.includes("[Click here to leave a review]") && !messageTemplate.includes(fiveStarReviewLink)) {
              htmlTemplate = `${messageTemplate}\n\nPlease leave us a review: [Click here to leave a review]`;
              finalEmailMessage = htmlTemplate; // Update text version too
            }
            
            let htmlWithLinks = escapeHtml(htmlTemplate)
              .replace(/(https?:\/\/[^\s]+)/g, function(url, _m, offset, full) {
                const safeUrl = escapeHtml(url);
                // If this URL is already part of an href attribute, skip
                const before = full.slice(Math.max(0, offset - 10), offset);
                if (before.includes('href="') || before.includes("href='")) return url;
                if (url.includes('google.com') && (url.includes('review') || url.includes('writereview') || url.includes('lrd=') || url.includes('search?q=') || url.includes('local/writereview'))) {
                  return `<a href="${safeUrl}" target="_blank" rel="noopener noreferrer" style="color: #1e3a8a; text-decoration: underline; font-weight: 500;">Click here to leave a review</a>`;
                }
                return `<a href="${safeUrl}" target="_blank" rel="noopener noreferrer" style="color: #1e3a8a; text-decoration: underline;">${safeUrl}</a>`;
              });

            const safeHtml = htmlWithLinks
              .replace(/\[Click here to leave a review\]/g, function() {
                const linkToUse = trackingUrl || fiveStarReviewLink;
                const safeUrl = escapeHtml(linkToUse);
                return `<a href="${safeUrl}" target="_blank" rel="noopener noreferrer" style="color: #1e3a8a; text-decoration: underline; font-weight: 500;">Click here to leave a review</a>`;
              })
              .replace(/\n/g, "<br>");

            const friendlyName = (profileSenderDisplay || profileSenderName || '').trim();
            const fullNameForSubject = document.getElementById('fullName').value.trim();
            const mailPayload = {
              to: email,
              from: friendlyName ? `${friendlyName} <feedback@ezreviews.app>` : 'feedback@ezreviews.app',
              message: {
                subject: `We'd love your feedback, ${preferredName || fullNameForSubject || "friend"}!`,
                html: safeHtml
              }
            };
            
            // Apply custom email subject if configured
            if (userEmailSubject) {
              const subjectName = preferredName || fullNameForSubject || 'friend';
              mailPayload.message.subject = userEmailSubject.replaceAll('{name}', subjectName);
            }
            console.log("📧 Sending email:", mailPayload);
            try {
              await db.collection("mail").add(mailPayload);
            } catch (err) {
              console.warn('First attempt to queue email failed, retrying with simplified from:', err?.message || err);
              try {
                // Fallback: some environments may reject display names in From
                const fallbackPayload = { ...mailPayload, from: 'feedback@ezreviews.app' };
                await db.collection("mail").add(fallbackPayload);
                console.log('📧 Retried email queued with fallback from.');
              } catch (err2) {
                console.error('❌ Failed to queue email:', err2);
                showToast("Failed to queue email: " + (err2.message || ''), 'error', 'Error');
                throw err2; // bubble to outer catch to stop success flow
              }
            }
            
            // Log delivery record
            try {
              const deliveryRef = await db.collection('deliveries').add({
                ownerEmail: currentUser.email,
                patientFullName: document.getElementById('fullName').value.trim(),
                patientPreferredName: preferredName || '',
                to: email,
                channel: 'email',
                message: finalEmailMessage,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                trackingId: emailTrackingRef ? emailTrackingRef.id : null
              });
              
              // Update tracking record with delivery ID and final HTML
              if (emailTrackingRef) {
                await emailTrackingRef.update({
                  deliveryId: deliveryRef.id,
                  finalMessage: finalEmailMessage,
                  finalHtml: safeHtml // Store the final HTML with tracking URL
                });
              }
            } catch (e) { console.warn('Failed to log email delivery', e); }
            showToast("Email queued for delivery.", 'success', 'Sent');
          }
        } catch (err) {
          console.error("❌ Error during submission:", err);
          showToast("Failed to send one or more messages: " + (err.message || ''), 'error', 'Error');
        }
      });
    });
  </script>
</body>
</html>
