<script>
  document.addEventListener("DOMContentLoaded", function () {
    const firebaseConfig = {
      apiKey: "AIzaSyD20NR1jIBq_L3znffAe8c82VH49NcMmeE",
      authDomain: "ezreview-ee8f0.firebaseapp.com",
      projectId: "ezreview-ee8f0",
      storageBucket: "ezreview-ee8f0.firebasestorage.app",
      messagingSenderId: "985522835249",
      appId: "1:985522835249:web:fda8bab4bac91fb898ea10",
      measurementId: "G-RBB28JDVJW"
    };

    firebase.initializeApp(firebaseConfig);
    firebase.analytics();
    const db = firebase.firestore();

    // üîí LocalStorage-based auth
    const username = localStorage.getItem("username");
    if (!username) {
      window.location.href = "index.html";
      return;
    } else {
      document.getElementById("headerText").textContent = `Review for: ${username}`;
    }

    const preferredNameInput = document.getElementById("preferredName");
    const messageBox = document.getElementById("message");

    preferredNameInput.addEventListener("input", () => {
      const name = preferredNameInput.value || "[preferred name]";
      const defaultMessage = `Hello ${name},

Thank you so much for letting us take care of you. We hope you enjoyed your time with us. Feedback is very valuable and we would love to hear from you. Please visit this link to leave a review!

Thanks!
Sarah`;

      if (messageBox.value === "" || messageBox.value.includes("[preferred name]")) {
        messageBox.value = defaultMessage;
      } else {
        messageBox.value = messageBox.value.replace(/^Hello .*,/m, `Hello ${name},`);
      }
    });

    document.getElementById("patientForm").addEventListener("submit", async function (e) {
      e.preventDefault();

      const phone = document.getElementById("phone").value.trim();
      const email = document.getElementById("email").value.trim();
      const preferredName = document.getElementById("preferredName").value.trim();
      const sendText = document.getElementById("sendText").checked;
      const sendEmail = document.getElementById("sendEmail").checked;
      const message = document.getElementById("message").value.trim();

      if (!(sendText || sendEmail)) {
        alert("Please select at least one delivery method (Text or Email).");
        return;
      }

      try {
        if (sendText && phone && message) {
          const smsPayload = {
            to: "+1" + phone.replace(/\D/g, ""),
            body: message
          };
          console.log("üì± Sending SMS:", smsPayload);
          await db.collection("messages").add(smsPayload);
          alert("SMS message queued for delivery.");
        }

        if (sendEmail && email && message) {
          const mailPayload = {
            to: email,
            message: {
              subject: `We‚Äôd love your feedback, ${preferredName || "friend"}!`,
              text: message
            }
          };
          console.log("üìß Sending email:", mailPayload);
          await db.collection("mail").add(mailPayload);
          alert("Email queued for delivery.");
        }
      } catch (err) {
        console.error("‚ùå Error during submission:", err);
        alert("‚ùå Failed to send one or more messages:\n" + err.message);
      }
    });
  });
</script>
