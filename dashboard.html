<script>
  const firebaseConfig = {
    apiKey: "AIzaSyD20NR1jIBq_L3znffAe8c82VH49NcMmeE",
    authDomain: "ezreview-ee8f0.firebaseapp.com",
    projectId: "ezreview-ee8f0",
    storageBucket: "ezreview-ee8f0.firebasestorage.app",
    messagingSenderId: "985522835249",
    appId: "1:985522835249:web:fda8bab4bac91fb898ea10",
    measurementId: "G-RBB28JDVJW"
  };
  firebase.initializeApp(firebaseConfig);
  firebase.analytics();
  const db = firebase.firestore();

  firebase.auth().onAuthStateChanged(async user => {
    if (!user) {
      window.location.href = "index.html";
      return;
    }

    try {
      const snapshot = await db.collection("users").where("email", "==", user.email).limit(1).get();
      if (!snapshot.empty) {
        const fullname = snapshot.docs[0].data().fullname;
        document.getElementById("headerText").textContent = `Review for: ${fullname}`;
      } else {
        document.getElementById("headerText").textContent = "Review for: [Unknown User]";
      }
    } catch (err) {
      console.error("Error fetching user data:", err);
      document.getElementById("headerText").textContent = "Review for: [Error]";
    }
  });

  // Update preferred name in message
  const preferredNameInput = document.getElementById("preferredName");
  const messageBox = document.getElementById("message");

  preferredNameInput.addEventListener("input", () => {
    const name = preferredNameInput.value || "[preferred name]";
    const defaultMessage = `Hello [preferred name],\n\nThank you so much for letting us take care of you. We hope you enjoyed your time with us. Feedback is very valuable and we would love to hear from you. Please visit this link to leave a review!\n\nThanks!\nSarah`;

    if (messageBox.value === "" || messageBox.value.includes("[preferred name]")) {
      messageBox.value = defaultMessage.replace("[preferred name]", name);
    } else {
      messageBox.value = messageBox.value.replace(/^Hello .*,/m, `Hello ${name},`);
    }
  });

  // Handle form submission
  document.getElementById("patientForm").addEventListener("submit", async function (e) {
    e.preventDefault();

    const phone = document.getElementById("phone").value.trim();
    const sendText = document.getElementById("sendText").checked;
    const message = document.getElementById("message").value.trim();

    if (sendText && phone && message) {
      try {
        await db.collection("messages").add({
          to: `+1${phone}`,
          body: message
        });
        alert("SMS message queued for delivery.");
      } catch (err) {
        console.error("Error sending SMS:", err);
        alert("Failed to send SMS message.");
      }
    } else {
      alert("Please check \"Send via Text\" and enter a valid phone number and message.");
    }
  });
</script>
