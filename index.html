<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Login | Feedback Tool</title>
  <link rel="stylesheet" href="css/style.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <!-- Firebase JS SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-analytics-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD20NR1jIBq_L3znffAe8c82VH49NcMmeE",
      authDomain: "ezreview-ee8f0.firebaseapp.com",
      projectId: "ezreview-ee8f0",
      storageBucket: "ezreview-ee8f0.firebasestorage.app",
      messagingSenderId: "985522835249",
      appId: "1:985522835249:web:fda8bab4bac91fb898ea10",
      measurementId: "G-RBB28JDVJW"
    };

    firebase.initializeApp(firebaseConfig);
    firebase.analytics();
  </script>
   <!-- Footer Logo Styles -->
  <style>
  .logo-container {
    text-align: center;
    margin-top: 2rem;
  }

  .logo {
    height: 150px; /* ‚Üê increase this value as needed */
    opacity: 0.95;
    transition: opacity 0.3s ease;
  }

  .logo:hover {
    opacity: 1;
  }
    .footer-logo {
      margin-top: 2rem;
      text-align: center;
      padding: 1rem;
    }

    .footer-logo img {
      height: 40px;
      opacity: 0.85;
      transition: opacity 0.3s ease;
    }

    .footer-logo img:hover {
      opacity: 1;
    }
  </style>
</head>
<body>

  <!-- Top bar for auxiliary actions -->
  <div class="topbar">
    <button id="logoutBtn" class="btn btn-secondary" style="display:none;">Log out</button>
  </div>

  <!-- Logo -->
  <div class="logo-container">
    <img src="logo.png" alt="Logo" class="logo">
  </div>

  <!-- Tagline -->
  <div class="muted-text" style="margin-top:.5rem; margin-bottom:1.25rem; text-align:center;">
    Modern patient feedback ‚Äî simple, professional, and fast.
  </div>

  <!-- Login Card -->
  <div class="card" style="max-width:480px;">
    <h2 style="margin-bottom:.5rem; text-align:center;">Welcome back</h2>
    <p class="muted-text" style="text-align:center; margin-bottom:1.25rem;">Sign in to continue</p>
    <form id="loginForm">
      <div class="form-group full">
        <label for="identifier">Email or Username</label>
        <input type="text" id="identifier" placeholder="you@clinic.com or username" autocomplete="username" required>
      </div>

      <div class="form-group full">
        <label for="password">Password</label>
        <input type="password" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
      </div>

      <div class="form-group full">
        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
          <input type="checkbox" id="keepLoggedIn" checked>
          <span>Keep me logged in</span>
        </label>
      </div>

      <div class="form-group full" style="display:flex; gap:.75rem; align-items:center; justify-content:space-between;">
        <button type="submit" class="btn btn-primary btn-pill btn-elevated btn-with-icon" style="flex:1.2;">
          <span>Sign in</span>
          <span class="icon">‚Üí</span>
        </button>
        <div style="display:flex; flex-direction:column; align-items:flex-end; gap:.25rem;">
          <button type="button" id="forgotBtn" class="btn btn-link" style="padding:0;">Forgot password?</button>
          <div style="display:flex; gap:.75rem;">
            <button type="button" id="forgotUsernameBtn" class="btn btn-link" style="padding:0;">Forgot username?</button>
            <button type="button" id="forgotEmailBtn" class="btn btn-link" style="padding:0;">Forgot email?</button>
          </div>
        </div>
      </div>

      <p id="error" class="error-text" style="display:none; text-align:center; margin-top:.25rem;"></p>
      <p id="info" class="muted-text" style="display:none; text-align:center; margin-top:.25rem;"></p>
    </form>
  </div>

  <!-- Login Script -->
  <script>
    const db = firebase.firestore();

    document.getElementById("loginForm").addEventListener("submit", async function (e) {
      e.preventDefault();

      const identifier = document.getElementById("identifier").value.trim();
      const password = document.getElementById("password").value.trim();
      const keepLoggedIn = document.getElementById("keepLoggedIn").checked;
      const errorElem = document.getElementById("error");
      errorElem.style.display = "none";

      try {
        // Set Firebase Auth persistence based on checkbox
        const persistence = keepLoggedIn ? firebase.auth.Auth.Persistence.LOCAL : firebase.auth.Auth.Persistence.SESSION;
        await firebase.auth().setPersistence(persistence);

        // Resolve identifier ‚Üí email if needed, then sign in
        let resolvedEmail = identifier;
        if (!identifier.includes('@')) {
          const uname = identifier.toLowerCase();
          const doc = await db.collection('usernames').doc(uname).get();
          if (!doc.exists) { throw new Error('Username not found'); }
          const m = doc.data();
          if (!m || !m.email) { throw new Error('Username mapping invalid'); }
          resolvedEmail = m.email;
        }

        await firebase.auth().signInWithEmailAndPassword(resolvedEmail, password);

        // üîé Check profile to determine next step
        const qs = await db.collection('users').where('email', '==', resolvedEmail).limit(1).get();
        if (!qs.empty) {
          const data = qs.docs[0].data();
          if (data.needsPasswordChange === true) {
            try { localStorage.setItem('showPwReminder', '1'); } catch {}
          }
          if (!(data.fullName && data.reviewLink)) {
            window.location.href = 'profile.html';
            return;
          }
          window.location.href = 'dashboard.html';
          return;
        }
        // No profile doc yet ‚Üí go set it up
        window.location.href = 'profile.html';
      } catch (error) {
        errorElem.innerText = error.message;
        errorElem.style.display = "block";
      }
    });

    // Forgot password
    document.getElementById('forgotBtn').addEventListener('click', async () => {
      const identifier = document.getElementById('identifier').value.trim();
      const info = document.getElementById('info');
      const err = document.getElementById('error');
      info.style.display = 'none';
      err.style.display = 'none';
      if (!identifier) {
        err.textContent = 'Enter your email or username above first.';
        err.style.display = 'block';
        return;
      }
      try {
        let emailToReset = identifier;
        if (!identifier.includes('@')) {
          const uname = identifier.toLowerCase();
          const doc = await db.collection('usernames').doc(uname).get();
          if (!doc.exists) { throw new Error('Username not found'); }
          const m = doc.data();
          if (!m || !m.email) { throw new Error('Username mapping invalid'); }
          emailToReset = m.email;
        }
        await firebase.auth().sendPasswordResetEmail(emailToReset);
        info.textContent = 'Password reset email sent.';
        info.style.display = 'block';
      } catch (e) {
        err.textContent = e.message;
        err.style.display = 'block';
      }
    });

    // Forgot username (enter your email ‚Üí we show your username)
    document.getElementById('forgotUsernameBtn').addEventListener('click', async () => {
      const identifier = document.getElementById('identifier').value.trim();
      const info = document.getElementById('info');
      const err = document.getElementById('error');
      info.style.display = 'none'; err.style.display = 'none';
      if (!identifier || !identifier.includes('@')) {
        err.textContent = 'Enter your account email above first.';
        err.style.display = 'block';
        return;
      }
      try {
        const qs = await db.collection('usernames').where('email', '==', identifier).limit(1).get();
        if (qs.empty) { throw new Error('No username found for that email'); }
        const username = qs.docs[0].id;
        info.textContent = `Your username: ${username}`;
        info.style.display = 'block';
      } catch (e) {
        err.textContent = e.message || 'Unable to look up username';
        err.style.display = 'block';
      }
    });

    // Forgot email (enter your username ‚Üí we show a masked email)
    document.getElementById('forgotEmailBtn').addEventListener('click', async () => {
      const identifier = document.getElementById('identifier').value.trim();
      const info = document.getElementById('info');
      const err = document.getElementById('error');
      info.style.display = 'none'; err.style.display = 'none';
      if (!identifier || identifier.includes('@')) {
        err.textContent = 'Enter your username above first.';
        err.style.display = 'block';
        return;
      }
      try {
        const uname = identifier.toLowerCase();
        const doc = await db.collection('usernames').doc(uname).get();
        if (!doc.exists) { throw new Error('Username not found'); }
        const m = doc.data();
        if (!m || !m.email) { throw new Error('Username mapping invalid'); }
        const email = m.email;
        const masked = (function maskEmail(e){
          const [local, domain] = e.split('@');
          const mask = (s) => s.length <= 2 ? s[0] + '*' : s[0] + '*'.repeat(Math.max(1, s.length-2)) + s[s.length-1];
          const [domRoot, ...domRest] = domain.split('.');
          return `${mask(local)}@${mask(domRoot)}.${domRest.join('.')}`;
        })(email);
        info.textContent = `Account email looks like: ${masked}`;
        info.style.display = 'block';
      } catch (e) {
        err.textContent = e.message || 'Unable to look up email';
        err.style.display = 'block';
      }
    });

    // Conditionally show logout if already signed in
    firebase.auth().onAuthStateChanged(async (user) => {
      const btn = document.getElementById('logoutBtn');
      btn.style.display = user ? 'inline-flex' : 'none';
      
      // If user is already authenticated, redirect to dashboard (temporary bypass)
      if (user) {
        window.location.href = 'dashboard.html';
      }
    });
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      try { await firebase.auth().signOut(); } catch {}
      window.location.reload();
    });
  </script>
  <!-- Footer -->
  <footer class="footer-logo">
    <a href="https://biminiai.com" target="_blank" rel="noopener">
      <img src="biminilogo.png" alt="Bimini Logo">
    </a>
  </footer>

</body>
</html>
